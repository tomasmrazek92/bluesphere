"use strict";(()=>{(function(){let y={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},i={log:(...e)=>y.DEBUG&&console.log("[ORDER]",...e),error:(...e)=>console.error("[ORDER]",...e)},m=(e,t=document)=>t.querySelector(e),E=(e,t=document)=>[...t.querySelectorAll(e)],_=e=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e/100);function L(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(i.error("CartModal.PACKAGES not available"),{})}function f(e,t="info"){var c;let a=((c=document.querySelector(".navbar"))==null?void 0:c.getBoundingClientRect().bottom)||80,n=document.createElement("div");n.style.cssText=`position:fixed;top:${a+8}px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}let v=null,w=null,K=0;function S(){if(!window.CartModal){K++<50?(i.log("Waiting for CartModal..."),setTimeout(S,100)):i.log("CartModal not available after 5s, giving up");return}let e=L(),t=window.CartModal.getItems(),a=window.CartModal.calculate(t);if(i.log("Rendering cart:",t.length,"items",a),!v){let r=m('[data-flow="cart-item"]');r&&(v=r.cloneNode(!0),w=r.parentElement,r.setAttribute("data-template","original"),i.log("Cart template initialized"))}if(w&&E("[data-cloned]",w).forEach(r=>r.remove()),v&&w){let r=m('[data-template="original"]',w);t.length===0?r&&(r.style.display="none"):t.forEach((l,u)=>{let o=e[l.sku];if(!o)return;let d=a.prices.find(b=>b.sku===l.sku),s;u===0&&r?(s=r,s.style.display=""):(s=v.cloneNode(!0),s.setAttribute("data-cloned","true"),s.removeAttribute("data-template"),w.appendChild(s)),s.setAttribute("data-sku",l.sku);let p=m('[data-flow="cart-item-img"]',s);p&&(p.src=o.image,p.alt=o.name);let h=m('[data-flow="cart-item-title"]',s);h&&(h.textContent=o.name);let g=m('[data-flow="cart-item-desc"]',s);g&&(g.textContent=`${Object.keys(o.biomarkers).length} Biomarker`);let C=m('[data-flow="cart-item-price"]',s);C&&(C.textContent=_((d==null?void 0:d.final)||o.basePrice));let B=m('[data-flow="cart-item-price-unit"]',s);B&&(B.textContent="\u20AC");let x=m('[data-flow="cart-item-remove"]',s);if(x){let b=x.cloneNode(!0);x.parentNode.replaceChild(b,x),b.style.cursor="pointer",b.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),window.CartModal.remove(l.sku),f("Paket entfernt","info")})}})}let n=m('[data-flow="total-price"]');n&&(n.textContent=_(a.total));let c=m('[data-flow="total-price-unit"]');c&&(c.textContent="\u20AC"),E("[data-cart-count]").forEach(r=>r.textContent=t.length),i.log("Cart render complete. Total:",_(a.total))}let I=!1;function k(){let e=m('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),t=e==null?void 0:e.value;if(!t&&e){let a=e.nextElementSibling;if(a&&a.classList.contains("nice-select")){let n=a.querySelector(".option.selected");n&&n.getAttribute("data-value")&&(t=n.getAttribute("data-value"))}}return{practiceSelect:e,practice:t}}function A(){let e=m("#choose-appointment-headline"),t=m(".w-embed.w-iframe"),a=window.Auth&&window.Auth.isAuthenticated(),{practice:n}=k(),c=a&&!!n;i.log("updateAppointmentSection, authenticated:",a,"practice:",n),e&&(e.style.display=c?"":"none"),t&&(t.style.display=c?"":"none"),c&&t&&!I&&(T(t),I=!0),!c&&t&&(t.innerHTML="",I=!1),D()}function D(){let e=E('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]'),{practice:t}=k(),a=!!t;e.forEach(n=>{n.style.opacity=a?"":"0.5",n.style.pointerEvents="auto"})}function T(e){let t=window.Auth?window.Auth.getCurrentUser():null,a=(t==null?void 0:t.name)||localStorage.getItem("userName")||"",n=(t==null?void 0:t.email)||localStorage.getItem("userEmail")||"",c=a.trim().split(/\s+/),r=y.CALENDLY_BASE_URL+"?hide_gdpr_banner=1";a&&(r+="&name="+encodeURIComponent(a)),n&&(r+="&email="+encodeURIComponent(n)),e.innerHTML="",e.style.overflow="visible",e.style.height="auto",e.style.minHeight="1100px";let l=document.createElement("div");l.className="calendly-widget-container",l.style.cssText="min-width:100%;height:1100px;",e.appendChild(l),window.addEventListener("message",function(d){var s,p,h;if(((s=d.data)==null?void 0:s.event)==="calendly.page_height"&&((h=(p=d.data)==null?void 0:p.payload)!=null&&h.height)){let g=Math.ceil(parseFloat(d.data.payload.height));if(g>0){l.style.height=g+"px",e.style.minHeight=g+"px";let C=l.querySelector("iframe");C&&(C.style.height=g+"px")}}});function u(){i.log("Initializing inline Calendly widget");try{window.Calendly.initInlineWidget({url:r,parentElement:l,prefill:{firstName:c[0]||"",lastName:c.slice(1).join(" ")||"",email:n}}),l.classList.add("calendly-inline-widget");let o=l.querySelector("iframe");o&&(o.style.height="100%",o.style.minHeight="1100px"),i.log("Inline Calendly widget initialized")}catch(o){i.error("Calendly.initInlineWidget failed:",o);let d=document.createElement("iframe");d.src=r,d.style.cssText="width:100%;height:100%;border:none;",l.appendChild(d)}}if(window.Calendly)u();else{if(!document.querySelector('link[href*="assets.calendly.com"]')){let o=document.createElement("link");o.rel="stylesheet",o.href="https://assets.calendly.com/assets/external/widget.css",document.head.appendChild(o)}if(document.querySelector('script[src*="assets.calendly.com"]')){let o=setInterval(()=>{window.Calendly&&(clearInterval(o),u())},100);setTimeout(()=>clearInterval(o),5e3)}else{let o=document.createElement("script");o.src="https://assets.calendly.com/assets/external/widget.js",o.async=!0,o.setAttribute("data-cookieconsent","ignore"),o.onload=()=>{window.Calendly?u():i.error("widget.js loaded but window.Calendly undefined")},o.onerror=()=>{i.error("Failed to load Calendly widget.js");let d=document.createElement("iframe");d.src=r,d.style.cssText="width:100%;height:100%;border:none;",l.appendChild(d)},document.head.appendChild(o)}}}function N(){let{practiceSelect:e}=k();e&&e.addEventListener("change",()=>{i.log("Practice changed"),A()}),document.addEventListener("click",t=>{t.target.closest(".nice-select .option")&&setTimeout(()=>{i.log("Nice-select option clicked"),A()},50)})}function U(){document.addEventListener("click",e=>{var d,s,p;if(!((d=e.target)==null?void 0:d.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;e.preventDefault(),e.stopPropagation(),i.log("Checkout clicked");let{practiceSelect:a,practice:n}=k();if(!n){f("Bitte w\xE4hle Praxis","error");return}if(window.Auth&&!window.Auth.isAuthenticated()){f("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){i.error("CartModal not available");return}let c=window.CartModal.getItems();if(c.length===0){f("Warenkorb ist leer","error");return}let r=L(),l=window.CartModal.calculate(c),u=window.Auth?window.Auth.getCurrentUser():null,o={user_id:(u==null?void 0:u.id)||localStorage.getItem("userId")||"",name:(u==null?void 0:u.name)||"Guest",email:(u==null?void 0:u.email)||"",practice:((p=(s=a==null?void 0:a.options)==null?void 0:s[a.selectedIndex])==null?void 0:p.text)||n,total:l.total,packages:c.map(h=>{var g;return(g=r[h.sku])==null?void 0:g.name}).join(", "),items:c};sessionStorage.setItem("pending_booking",JSON.stringify(o)),f("Buchungsdaten gespeichert. Bitte Termin im Kalender unten w\xE4hlen.","success")},!0)}window.addEventListener("message",e=>{var t,a,n;if(e.origin&&e.origin.includes("calendly")&&i.log("Calendly postMessage received:",{origin:e.origin,event:(t=e.data)==null?void 0:t.event,data:e.data}),((a=e.data)==null?void 0:a.event)==="calendly.event_scheduled"){i.log("Booking completed!");let c=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");i.log("Booking data from session:",c);let r={event_type:"blood_test_booked",user_id:Number(c.user_id)||0,event_data:{...c,calendly_event:((n=e.data)==null?void 0:n.payload)||{}}};i.log("Sending webhook payload:",r),i.log("Webhook URL:",y.WEBHOOK_DEV),fetch(y.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":y.WEBHOOK_KEY_DEV},body:JSON.stringify(r)}).then(l=>(i.log("Webhook response:",l.status,l.statusText),l.text())).then(l=>i.log("Webhook response body:",l)).catch(l=>i.error("Webhook error:",l)),window.CartModal&&window.CartModal.clear(),f("Termin erfolgreich gebucht!","success")}});function W(){let e=E('[data-flow="cart-empty"], [data-cart="cart-empty"]');e.forEach(a=>{a.style.cursor="pointer",a.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),window.CartModal&&window.CartModal.clear(),f("Warenkorb geleert","info")})}),i.log("Clear cart buttons initialized:",e.length);let t=m(".order_back");t&&(t.style.cursor="pointer",t.addEventListener("click",()=>{window.history.length>1?window.history.back():window.location.href="/biomarker-packages"}))}function M(){window.Auth&&window.Auth.updateUI()}function O(){i.log("Order page initializing"),S(),W(),U(),N(),M(),A(),window.addEventListener("cart-updated",()=>{S()}),window.addEventListener("auth-changed",()=>{M(),A()}),i.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O()})();})();
