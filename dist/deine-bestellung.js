"use strict";(()=>{(function(){let y={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},o={log:(...e)=>y.DEBUG&&console.log("[ORDER]",...e),error:(...e)=>console.error("[ORDER]",...e)},c=(e,a=document)=>a.querySelector(e),v=(e,a=document)=>[...a.querySelectorAll(e)],b=e=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e/100);function A(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(o.error("CartModal.PACKAGES not available"),{})}function p(e,a="info"){let i=document.createElement("div");i.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${a==="success"?"#00a86b":a==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.style.opacity="0",setTimeout(()=>i.remove(),300)},3e3)}let E=null,f=null;function x(){if(!window.CartModal){o.log("Waiting for CartModal..."),setTimeout(x,100);return}let e=A(),a=window.CartModal.getItems(),i=window.CartModal.calculate(a);if(o.log("Rendering cart:",a.length,"items",i),!E){let t=c('[data-flow="cart-item"]');t&&(E=t.cloneNode(!0),f=t.parentElement,t.setAttribute("data-template","original"),o.log("Cart template initialized"))}if(f&&v("[data-cloned]",f).forEach(t=>t.remove()),E&&f){let t=c('[data-template="original"]',f);a.length===0?t&&(t.style.display="none"):a.forEach((n,s)=>{let u=e[n.sku];if(!u)return;let w=i.prices.find(C=>C.sku===n.sku),r;s===0&&t?(r=t,r.style.display=""):(r=E.cloneNode(!0),r.setAttribute("data-cloned","true"),r.removeAttribute("data-template"),f.appendChild(r)),r.setAttribute("data-sku",n.sku);let h=c('[data-flow="cart-item-img"]',r);h&&(h.src=u.image,h.alt=u.name);let g=c('[data-flow="cart-item-title"]',r);g&&(g.textContent=u.name);let m=c('[data-flow="cart-item-desc"]',r);m&&(m.textContent=`${Object.keys(u.biomarkers).length} Biomarker`);let O=c('[data-flow="cart-item-price"]',r);O&&(O.textContent=b((w==null?void 0:w.final)||u.basePrice));let M=c('[data-flow="cart-item-price-unit"]',r);M&&(M.textContent="\u20AC");let k=c('[data-flow="cart-item-remove"]',r);if(k){let C=k.cloneNode(!0);k.parentNode.replaceChild(C,k),C.style.cursor="pointer",C.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),window.CartModal.remove(n.sku),p("Paket entfernt","info")})}})}let l=c('[data-flow="total-price"]');l&&(l.textContent=b(i.total));let d=c('[data-flow="total-price-unit"]');d&&(d.textContent="\u20AC"),v("[data-cart-count]").forEach(t=>t.textContent=a.length),o.log("Cart render complete. Total:",b(i.total))}function D(e){let a=new URLSearchParams({name:e.name,email:e.email,a1:`Praxis: ${e.practice}`,a2:`Preis: \u20AC${b(e.total)}`,a3:`Pakete: ${e.packages}`});return`${y.CALENDLY_BASE_URL}?${a}`}function K(e,a){let i=document.createElement("div");i.id="calendly-container",i.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",i.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${e}" style="flex:1;"></div>
      </div>`,document.body.appendChild(i);let l=i.querySelector(".calendly-inline-widget");o.log("Calendly widget container ready, loading widget.js...");function d(){o.log("Calling Calendly.initInlineWidget, window.Calendly:",!!window.Calendly);try{window.Calendly.initInlineWidget({url:e,parentElement:l,prefill:{name:a.name,email:a.email}}),o.log("Calendly.initInlineWidget called successfully")}catch(t){o.error("Calendly.initInlineWidget failed:",t),o.log("Falling back to direct iframe");let n=document.createElement("iframe");n.src=e,n.style.cssText="width:100%;height:100%;border:none;",l.appendChild(n)}}if(window.Calendly)d();else{if(!document.querySelector('link[href*="assets.calendly.com"]')){let n=document.createElement("link");n.rel="stylesheet",n.href="https://assets.calendly.com/assets/external/widget.css",document.head.appendChild(n)}let t=document.createElement("script");t.src="https://assets.calendly.com/assets/external/widget.js",t.type="text/javascript",t.async=!0,t.setAttribute("data-cookieconsent","ignore"),t.onload=()=>{o.log("Calendly widget.js loaded, window.Calendly:",!!window.Calendly),window.Calendly?d():o.error("widget.js loaded but window.Calendly still undefined")},t.onerror=n=>{o.error("Failed to load Calendly widget.js:",n);let s=document.createElement("iframe");s.src=e,s.style.cssText="width:100%;height:100%;border:none;",l.appendChild(s)},document.head.appendChild(t)}}function B(){document.addEventListener("click",e=>{var w,r,h;if(!((w=e.target)==null?void 0:w.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(e.preventDefault(),e.stopPropagation(),o.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){p("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){o.error("CartModal not available");return}let i=window.CartModal.getItems();if(i.length===0){p("Warenkorb ist leer","error");return}let l=c('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),d=l==null?void 0:l.value;if(!d&&l){let g=l.nextElementSibling;if(g&&g.classList.contains("nice-select")){let m=g.querySelector(".option.selected");m&&m.getAttribute("data-value")&&(d=m.getAttribute("data-value"))}}if(!d){p("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let t=A(),n=window.CartModal.calculate(i),s=window.Auth?window.Auth.getCurrentUser():null,u={name:(s==null?void 0:s.name)||"Guest",email:(s==null?void 0:s.email)||"",practice:((h=(r=l==null?void 0:l.options)==null?void 0:r[l.selectedIndex])==null?void 0:h.text)||d,total:n.total,packages:i.map(g=>{var m;return(m=t[g.sku])==null?void 0:m.name}).join(", "),items:i};sessionStorage.setItem("pending_booking",JSON.stringify(u)),K(D(u),u)},!0)}window.addEventListener("message",e=>{var a,i,l;if(e.origin&&e.origin.includes("calendly")&&o.log("Calendly postMessage received:",{origin:e.origin,event:(a=e.data)==null?void 0:a.event,data:e.data}),((i=e.data)==null?void 0:i.event)==="calendly.event_scheduled"){o.log("Booking completed!");let d=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");o.log("Booking data from session:",d);let t={event_type:"blood_test_booked",event_data:{...d,calendly_event:((l=e.data)==null?void 0:l.payload)||{}}};o.log("Sending webhook payload:",t),o.log("Webhook URL:",y.WEBHOOK_DEV),fetch(y.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":y.WEBHOOK_KEY_DEV},body:JSON.stringify(t)}).then(n=>(o.log("Webhook response:",n.status,n.statusText),n.text())).then(n=>o.log("Webhook response body:",n)).catch(n=>o.error("Webhook error:",n)),window.CartModal&&window.CartModal.clear(),p("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var n;return(n=document.getElementById("calendly-container"))==null?void 0:n.remove()},2e3)}});function L(){let e=c('[data-flow="cart-empty"], [data-cart="cart-empty"]');e&&(e.style.cursor="pointer",e.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),window.CartModal&&window.CartModal.clear(),p("Warenkorb geleert","info")}),o.log("Clear cart button initialized"))}function _(){window.Auth&&window.Auth.updateUI()}function S(){o.log("Order page initializing"),x(),L(),B(),_(),window.addEventListener("cart-updated",()=>{x()}),window.addEventListener("auth-changed",()=>{_()}),o.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();})();
