"use strict";(()=>{(function(){let b={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},i={log:(...t)=>b.DEBUG&&console.log("[ORDER]",...t),error:(...t)=>console.error("[ORDER]",...t)},r=(t,n=document)=>n.querySelector(t),v=(t,n=document)=>[...n.querySelectorAll(t)],y=t=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t/100);function x(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(i.error("CartModal.PACKAGES not available"),{})}function s(t,n="info"){let e=document.createElement("div");e.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${n==="success"?"#00a86b":n==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),300)},3e3)}let C=null,u=null;function k(){if(!window.CartModal){i.log("Waiting for CartModal..."),setTimeout(k,100);return}let t=x(),n=window.CartModal.getItems(),e=window.CartModal.calculate(n);if(i.log("Rendering cart:",n.length,"items",e),!C){let a=r('[data-flow="cart-item"]');a&&(C=a.cloneNode(!0),u=a.parentElement,a.setAttribute("data-template","original"),i.log("Cart template initialized"))}if(u&&v("[data-cloned]",u).forEach(a=>a.remove()),C&&u){let a=r('[data-template="original"]',u);n.length===0?a&&(a.style.display="none"):n.forEach((m,d)=>{let l=t[m.sku];if(!l)return;let p=e.prices.find(h=>h.sku===m.sku),o;d===0&&a?(o=a,o.style.display=""):(o=C.cloneNode(!0),o.setAttribute("data-cloned","true"),o.removeAttribute("data-template"),u.appendChild(o)),o.setAttribute("data-sku",m.sku);let g=r('[data-flow="cart-item-img"]',o);g&&(g.src=l.image,g.alt=l.name);let w=r('[data-flow="cart-item-title"]',o);w&&(w.textContent=l.name);let S=r('[data-flow="cart-item-desc"]',o);S&&(S.textContent=`${Object.keys(l.biomarkers).length} Biomarker`);let O=r('[data-flow="cart-item-price"]',o);O&&(O.textContent=y((p==null?void 0:p.final)||l.basePrice));let M=r('[data-flow="cart-item-price-unit"]',o);M&&(M.textContent="\u20AC");let E=r('[data-flow="cart-item-remove"]',o);if(E){let h=E.cloneNode(!0);E.parentNode.replaceChild(h,E),h.style.cursor="pointer",h.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),window.CartModal.remove(m.sku),s("Paket entfernt","info")})}})}let c=r('[data-flow="total-price"]');c&&(c.textContent=y(e.total));let f=r('[data-flow="total-price-unit"]');f&&(f.textContent="\u20AC"),v("[data-cart-count]").forEach(a=>a.textContent=n.length),i.log("Cart render complete. Total:",y(e.total))}function K(t){let n=new URLSearchParams({name:t.name,email:t.email,a1:`Praxis: ${t.practice}`,a2:`Preis: \u20AC${y(t.total)}`,a3:`Pakete: ${t.packages}`});return`${b.CALENDLY_BASE_URL}?${n}`}function P(t,n){let e=document.createElement("div");e.id="calendly-container",e.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",e.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${t}" style="flex:1;"></div>
      </div>`,document.body.appendChild(e),window.Calendly&&Calendly.initInlineWidget({url:t,parentElement:e.querySelector(".calendly-inline-widget"),prefill:{name:n.name,email:n.email}})}function B(){document.addEventListener("click",t=>{var p,o;if(!((p=t.target)==null?void 0:p.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(t.preventDefault(),t.stopPropagation(),i.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){s("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){i.error("CartModal not available");return}let e=window.CartModal.getItems();if(e.length===0){s("Warenkorb ist leer","error");return}let c=r('[data-flow="practice-select"], #doctor-practice-select, select[name="practice"], select[name="doctor"]'),f=c==null?void 0:c.value;if(!f){s("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let a=x(),m=window.CartModal.calculate(e),d=window.Auth?window.Auth.getCurrentUser():null,l={name:(d==null?void 0:d.name)||"Guest",email:(d==null?void 0:d.email)||"",practice:((o=c.options[c.selectedIndex])==null?void 0:o.text)||f,total:m.total,packages:e.map(g=>{var w;return(w=a[g.sku])==null?void 0:w.name}).join(", "),items:e};sessionStorage.setItem("pending_booking",JSON.stringify(l)),P(K(l),l)},!0)}window.addEventListener("message",t=>{if(t.data.event==="calendly.event_scheduled"){i.log("Booking completed");let n=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");fetch(b.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":b.WEBHOOK_KEY_DEV},body:JSON.stringify({event_type:"blood_test_booked",event_data:n})}).catch(e=>i.error("Webhook error:",e)),window.CartModal&&window.CartModal.clear(),s("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var e;return(e=document.getElementById("calendly-container"))==null?void 0:e.remove()},2e3)}});function L(){let t=r('[data-flow="cart-empty"], [data-cart="cart-empty"]');t&&(t.style.cursor="pointer",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),window.CartModal&&window.CartModal.clear(),s("Warenkorb geleert","info")}),i.log("Clear cart button initialized"))}function A(){window.Auth&&window.Auth.updateUI()}function _(){i.log("Order page initializing"),k(),L(),B(),A(),window.addEventListener("cart-updated",()=>{k()}),window.addEventListener("auth-changed",()=>{A()}),i.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_):_()})();})();
