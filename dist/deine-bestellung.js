"use strict";(()=>{(function(){let C={DEBUG:!1,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/bluesphere-biomarker/bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},i={log:(...e)=>C.DEBUG&&console.log("[ORDER]",...e),error:(...e)=>console.error("[ORDER]",...e)},m=(e,t=document)=>t.querySelector(e),E=(e,t=document)=>[...t.querySelectorAll(e)],_=e=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e/100);function I(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(i.error("CartModal.PACKAGES not available"),{})}function w(e,t="info"){var s;let o=((s=document.querySelector(".navbar"))==null?void 0:s.getBoundingClientRect().bottom)||80,a=document.createElement("div");a.style.cssText=`position:fixed;top:${o+8}px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},3e3)}let v=null,p=null,N=0;function S(){if(!window.CartModal){N++<50?(i.log("Waiting for CartModal..."),setTimeout(S,100)):i.log("CartModal not available after 5s, giving up");return}let e=I(),t=window.CartModal.getItems(),o=window.CartModal.calculate(t);if(i.log("Rendering cart:",t.length,"items",o),!v){let n=m('[data-flow="cart-item"]');n&&(v=n.cloneNode(!0),p=n.parentElement,n.setAttribute("data-template","original"),i.log("Cart template initialized"))}if(p&&E("[data-cloned]",p).forEach(n=>n.remove()),v&&p){let n=m('[data-template="original"]',p),d=p==null?void 0:p.closest(".order_card"),r=d==null?void 0:d.querySelector(".cart-empty-state");if(r&&r.remove(),t.length===0){if(n&&(n.style.display="none"),d){let l=document.createElement("div");l.className="cart-empty-state",l.style.cssText="text-align:center;padding:3rem 2rem;",l.innerHTML='<p style="font-size:1.4rem;margin-bottom:1.5rem;color:#4B4B4E;">F\xFCge ein Biomarker Paket zum Warenkorb hinzu</p><a href="/biomarker" class="button w-inline-block" style="display:inline-flex;text-decoration:none;"><span>ZU DEN PAKETEN</span></a>',d.appendChild(l)}}else t.forEach((l,y)=>{let g=e[l.sku];if(!g)return;let f=o.prices.find(b=>b.sku===l.sku),c;y===0&&n?(c=n,c.style.display=""):(c=v.cloneNode(!0),c.setAttribute("data-cloned","true"),c.removeAttribute("data-template"),p.appendChild(c)),c.setAttribute("data-sku",l.sku);let h=m('[data-flow="cart-item-img"]',c);if(h){let b=l.image||g.image||"";h.src=b,h.removeAttribute("srcset"),h.removeAttribute("sizes"),h.alt=g.name}let O=m('[data-flow="cart-item-title"]',c);O&&(O.textContent=g.name);let P=m('[data-flow="cart-item-desc"]',c);P&&(P.textContent=`${Object.keys(g.biomarkers).length} Biomarker`);let K=m('[data-flow="cart-item-price"]',c);K&&(K.textContent=_((f==null?void 0:f.final)||g.basePrice));let T=m('[data-flow="cart-item-price-unit"]',c);T&&(T.textContent="\u20AC");let x=m('[data-flow="cart-item-remove"]',c);if(x){let b=x.cloneNode(!0);x.parentNode.replaceChild(b,x),b.style.cursor="pointer",b.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),window.CartModal.remove(l.sku),w("Paket entfernt","info")})}})}let a=m('[data-flow="total-price"]');a&&(a.textContent=_(o.total));let s=m('[data-flow="total-price-unit"]');s&&(s.textContent="\u20AC");let u=p==null?void 0:p.closest(".order_card");u&&Array.from(u.children).forEach(n=>{n.classList.contains("cart-empty-state")||(n.style.display=t.length===0?"none":"")}),E("[data-cart-count]").forEach(n=>n.textContent=t.length),i.log("Cart render complete. Total:",_(o.total))}let B=!1;function k(){let e=m('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),t=e==null?void 0:e.value;if(!t&&e){let o=e.nextElementSibling;if(o&&o.classList.contains("nice-select")){let a=o.querySelector(".option.selected");a&&a.getAttribute("data-value")&&(t=a.getAttribute("data-value"))}}return{practiceSelect:e,practice:t}}function A(){let e=m("#choose-appointment-headline"),t=m(".w-embed.w-iframe"),o=window.Auth&&window.Auth.isAuthenticated(),{practice:a}=k(),s=o&&!!a;i.log("updateAppointmentSection, authenticated:",o,"practice:",a),e&&(e.style.display=s?"":"none"),t&&(t.style.display=s?"":"none"),s&&t&&!B&&(W(t),B=!0),!s&&t&&(t.innerHTML="",B=!1),U()}function U(){let e=E('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]'),{practice:t}=k(),o=!!t;e.forEach(a=>{a.style.opacity=o?"":"0.5",a.style.pointerEvents="auto"})}function W(e){let t=window.Auth?window.Auth.getCurrentUser():null,o=(t==null?void 0:t.name)||localStorage.getItem("userName")||"",a=(t==null?void 0:t.email)||localStorage.getItem("userEmail")||"",s=o.trim().split(/\s+/),u=C.CALENDLY_BASE_URL+"?hide_gdpr_banner=1";o&&(u+="&name="+encodeURIComponent(o)),a&&(u+="&email="+encodeURIComponent(a)),e.innerHTML="",e.style.overflow="visible",e.style.height="auto",e.style.minHeight="1100px";let n=document.createElement("div");n.className="calendly-widget-container",n.style.cssText="min-width:100%;height:1100px;",e.appendChild(n),window.addEventListener("message",function(l){var y,g,f;if(((y=l.data)==null?void 0:y.event)==="calendly.page_height"&&((f=(g=l.data)==null?void 0:g.payload)!=null&&f.height)){let c=Math.ceil(parseFloat(l.data.payload.height));if(c>0){n.style.height=c+"px",e.style.minHeight=c+"px";let h=n.querySelector("iframe");h&&(h.style.height=c+"px")}}});function d(){i.log("Initializing inline Calendly widget");try{window.Calendly.initInlineWidget({url:u,parentElement:n,prefill:{firstName:s[0]||"",lastName:s.slice(1).join(" ")||"",email:a}}),n.style.fontSize="16px",n.style.lineHeight="1.2em";let r=n.querySelector("iframe");r&&(r.style.display="inline",r.style.height="100%",r.style.width="100%",r.style.minHeight="1100px"),i.log("Inline Calendly widget initialized")}catch(r){i.error("Calendly.initInlineWidget failed:",r);let l=document.createElement("iframe");l.src=u,l.style.cssText="width:100%;height:100%;border:none;",n.appendChild(l)}}if(window.Calendly)d();else{if(!document.querySelector('link[href*="assets.calendly.com"]')){let r=document.createElement("link");r.rel="stylesheet",r.href="https://assets.calendly.com/assets/external/widget.css",document.head.appendChild(r)}if(document.querySelector('script[src*="assets.calendly.com"]')){let r=setInterval(()=>{window.Calendly&&(clearInterval(r),d())},100);setTimeout(()=>clearInterval(r),5e3)}else{let r=document.createElement("script");r.src="https://assets.calendly.com/assets/external/widget.js",r.async=!0,r.setAttribute("data-cookieconsent","ignore"),r.onload=()=>{window.Calendly?d():i.error("widget.js loaded but window.Calendly undefined")},r.onerror=()=>{i.error("Failed to load Calendly widget.js");let l=document.createElement("iframe");l.src=u,l.style.cssText="width:100%;height:100%;border:none;",n.appendChild(l)},document.head.appendChild(r)}}}function z(){let{practiceSelect:e}=k();e&&e.addEventListener("change",()=>{i.log("Practice changed"),A()}),document.addEventListener("click",t=>{t.target.closest(".nice-select .option")&&setTimeout(()=>{i.log("Nice-select option clicked"),A()},50)})}function R(){document.addEventListener("click",e=>{var l,y,g;if(!((l=e.target)==null?void 0:l.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;e.preventDefault(),e.stopPropagation(),i.log("Checkout clicked");let{practiceSelect:o,practice:a}=k();if(!a){w("Bitte w\xE4hle eine Praxis","error");return}if(window.Auth&&!window.Auth.isAuthenticated()){w("Bitte registriere dich oder melde dich an","info"),window.Auth.openRegister();return}if(!window.CartModal){i.error("CartModal not available");return}let s=window.CartModal.getItems();if(s.length===0){w("Warenkorb ist leer","error");return}let u=I(),n=window.CartModal.calculate(s),d=window.Auth?window.Auth.getCurrentUser():null,r={user_id:(d==null?void 0:d.id)||localStorage.getItem("userId")||"",name:(d==null?void 0:d.name)||"Guest",email:(d==null?void 0:d.email)||"",practice:((g=(y=o==null?void 0:o.options)==null?void 0:y[o.selectedIndex])==null?void 0:g.text)||a,total:n.total,packages:s.map(f=>{var c;return(c=u[f.sku])==null?void 0:c.name}).join(", "),items:s};sessionStorage.setItem("pending_booking",JSON.stringify(r)),w("Buchungsdaten gespeichert. Bitte Termin im Kalender unten w\xE4hlen.","success")},!0)}window.addEventListener("message",e=>{var t,o,a;if(e.origin&&e.origin.includes("calendly")&&i.log("Calendly postMessage received:",{origin:e.origin,event:(t=e.data)==null?void 0:t.event,data:e.data}),((o=e.data)==null?void 0:o.event)==="calendly.event_scheduled"){i.log("Booking completed!");let s=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");i.log("Booking data from session:",s);let u={event_type:"blood_test_booked",user_id:Number(s.user_id)||0,event_data:{...s,calendly_event:((a=e.data)==null?void 0:a.payload)||{}}};i.log("Sending webhook payload:",u),i.log("Webhook URL:",C.WEBHOOK_DEV),fetch(C.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":C.WEBHOOK_KEY_DEV},body:JSON.stringify(u)}).then(n=>(i.log("Webhook response:",n.status,n.statusText),n.text())).then(n=>i.log("Webhook response body:",n)).catch(n=>i.error("Webhook error:",n)),window.CartModal&&window.CartModal.clear(),w("Termin erfolgreich gebucht!","success")}});function j(){let e=E('[data-flow="cart-empty"], [data-cart="cart-empty"]');e.forEach(o=>{o.style.cursor="pointer",o.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),window.CartModal&&window.CartModal.clear(),w("Warenkorb geleert","info")})}),i.log("Clear cart buttons initialized:",e.length);let t=m(".order_back");t&&(t.style.cursor="pointer",t.addEventListener("click",()=>{window.history.length>1?window.history.back():window.location.href="/biomarker"}))}function L(){window.Auth&&window.Auth.updateUI()}function M(){i.log("Order page initializing"),S(),j(),R(),z(),L(),A(),window.addEventListener("cart-updated",()=>{S()}),window.addEventListener("auth-changed",()=>{L(),A()}),i.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M()})();})();
