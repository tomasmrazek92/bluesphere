"use strict";(()=>{(function(){let y={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},o={log:(...e)=>y.DEBUG&&console.log("[ORDER]",...e),error:(...e)=>console.error("[ORDER]",...e)},s=(e,i=document)=>i.querySelector(e),v=(e,i=document)=>[...i.querySelectorAll(e)],b=e=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e/100);function A(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(o.error("CartModal.PACKAGES not available"),{})}function p(e,i="info"){let a=document.createElement("div");a.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${i==="success"?"#00a86b":i==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},3e3)}let E=null,f=null;function x(){if(!window.CartModal){o.log("Waiting for CartModal..."),setTimeout(x,100);return}let e=A(),i=window.CartModal.getItems(),a=window.CartModal.calculate(i);if(o.log("Rendering cart:",i.length,"items",a),!E){let t=s('[data-flow="cart-item"]');t&&(E=t.cloneNode(!0),f=t.parentElement,t.setAttribute("data-template","original"),o.log("Cart template initialized"))}if(f&&v("[data-cloned]",f).forEach(t=>t.remove()),E&&f){let t=s('[data-template="original"]',f);i.length===0?t&&(t.style.display="none"):i.forEach((n,c)=>{let m=e[n.sku];if(!m)return;let w=a.prices.find(C=>C.sku===n.sku),r;c===0&&t?(r=t,r.style.display=""):(r=E.cloneNode(!0),r.setAttribute("data-cloned","true"),r.removeAttribute("data-template"),f.appendChild(r)),r.setAttribute("data-sku",n.sku);let h=s('[data-flow="cart-item-img"]',r);h&&(h.src=m.image,h.alt=m.name);let g=s('[data-flow="cart-item-title"]',r);g&&(g.textContent=m.name);let u=s('[data-flow="cart-item-desc"]',r);u&&(u.textContent=`${Object.keys(m.biomarkers).length} Biomarker`);let O=s('[data-flow="cart-item-price"]',r);O&&(O.textContent=b((w==null?void 0:w.final)||m.basePrice));let P=s('[data-flow="cart-item-price-unit"]',r);P&&(P.textContent="\u20AC");let k=s('[data-flow="cart-item-remove"]',r);if(k){let C=k.cloneNode(!0);k.parentNode.replaceChild(C,k),C.style.cursor="pointer",C.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation(),window.CartModal.remove(n.sku),p("Paket entfernt","info")})}})}let l=s('[data-flow="total-price"]');l&&(l.textContent=b(a.total));let d=s('[data-flow="total-price-unit"]');d&&(d.textContent="\u20AC"),v("[data-cart-count]").forEach(t=>t.textContent=i.length),o.log("Cart render complete. Total:",b(a.total))}function D(e){let i=(e.name||"").trim().split(/\s+/),a=i[0]||"",l=i.slice(1).join(" ")||"",d=new URLSearchParams({first_name:a,last_name:l,email:e.email,a1:`Praxis: ${e.practice}`,a2:`Preis: \u20AC${b(e.total)}`,a3:`Pakete: ${e.packages}`});return`${y.CALENDLY_BASE_URL}?${d}`}function K(e,i){let a=document.createElement("div");a.id="calendly-container",a.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",a.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${e}" style="flex:1;"></div>
      </div>`,document.body.appendChild(a);let l=a.querySelector(".calendly-inline-widget");o.log("Calendly widget container ready, loading widget.js...");function d(){o.log("Calling Calendly.initInlineWidget, window.Calendly:",!!window.Calendly);try{let t=(i.name||"").trim().split(/\s+/);window.Calendly.initInlineWidget({url:e,parentElement:l,prefill:{firstName:t[0]||"",lastName:t.slice(1).join(" ")||"",email:i.email}}),o.log("Calendly.initInlineWidget called successfully")}catch(t){o.error("Calendly.initInlineWidget failed:",t),o.log("Falling back to direct iframe");let n=document.createElement("iframe");n.src=e,n.style.cssText="width:100%;height:100%;border:none;",l.appendChild(n)}}if(window.Calendly)d();else{if(!document.querySelector('link[href*="assets.calendly.com"]')){let n=document.createElement("link");n.rel="stylesheet",n.href="https://assets.calendly.com/assets/external/widget.css",document.head.appendChild(n)}let t=document.createElement("script");t.src="https://assets.calendly.com/assets/external/widget.js",t.type="text/javascript",t.async=!0,t.setAttribute("data-cookieconsent","ignore"),t.onload=()=>{o.log("Calendly widget.js loaded, window.Calendly:",!!window.Calendly),window.Calendly?d():o.error("widget.js loaded but window.Calendly still undefined")},t.onerror=n=>{o.error("Failed to load Calendly widget.js:",n);let c=document.createElement("iframe");c.src=e,c.style.cssText="width:100%;height:100%;border:none;",l.appendChild(c)},document.head.appendChild(t)}}function B(){document.addEventListener("click",e=>{var w,r,h;if(!((w=e.target)==null?void 0:w.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(e.preventDefault(),e.stopPropagation(),o.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){p("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){o.error("CartModal not available");return}let a=window.CartModal.getItems();if(a.length===0){p("Warenkorb ist leer","error");return}let l=s('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),d=l==null?void 0:l.value;if(!d&&l){let g=l.nextElementSibling;if(g&&g.classList.contains("nice-select")){let u=g.querySelector(".option.selected");u&&u.getAttribute("data-value")&&(d=u.getAttribute("data-value"))}}if(!d){p("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let t=A(),n=window.CartModal.calculate(a),c=window.Auth?window.Auth.getCurrentUser():null,m={name:(c==null?void 0:c.name)||"Guest",email:(c==null?void 0:c.email)||"",practice:((h=(r=l==null?void 0:l.options)==null?void 0:r[l.selectedIndex])==null?void 0:h.text)||d,total:n.total,packages:a.map(g=>{var u;return(u=t[g.sku])==null?void 0:u.name}).join(", "),items:a};sessionStorage.setItem("pending_booking",JSON.stringify(m)),K(D(m),m)},!0)}window.addEventListener("message",e=>{var i,a,l;if(e.origin&&e.origin.includes("calendly")&&o.log("Calendly postMessage received:",{origin:e.origin,event:(i=e.data)==null?void 0:i.event,data:e.data}),((a=e.data)==null?void 0:a.event)==="calendly.event_scheduled"){o.log("Booking completed!");let d=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");o.log("Booking data from session:",d);let t={event_type:"blood_test_booked",event_data:{...d,calendly_event:((l=e.data)==null?void 0:l.payload)||{}}};o.log("Sending webhook payload:",t),o.log("Webhook URL:",y.WEBHOOK_DEV),fetch(y.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":y.WEBHOOK_KEY_DEV},body:JSON.stringify(t)}).then(n=>(o.log("Webhook response:",n.status,n.statusText),n.text())).then(n=>o.log("Webhook response body:",n)).catch(n=>o.error("Webhook error:",n)),window.CartModal&&window.CartModal.clear(),p("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var n;return(n=document.getElementById("calendly-container"))==null?void 0:n.remove()},2e3)}});function L(){let e=s('[data-flow="cart-empty"], [data-cart="cart-empty"]');e&&(e.style.cursor="pointer",e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),window.CartModal&&window.CartModal.clear(),p("Warenkorb geleert","info")}),o.log("Clear cart button initialized"))}function _(){window.Auth&&window.Auth.updateUI()}function S(){o.log("Order page initializing"),x(),L(),B(),_(),window.addEventListener("cart-updated",()=>{x()}),window.addEventListener("auth-changed",()=>{_()}),o.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();})();
