"use strict";(()=>{(function(){let C={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},o={log:(...e)=>C.DEBUG&&console.log("[ORDER]",...e),error:(...e)=>console.error("[ORDER]",...e)},c=(e,t=document)=>t.querySelector(e),x=(e,t=document)=>[...t.querySelectorAll(e)],A=e=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e/100);function _(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(o.error("CartModal.PACKAGES not available"),{})}function f(e,t="info"){let n=document.createElement("div");n.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}let b=null,w=null;function k(){if(!window.CartModal){o.log("Waiting for CartModal..."),setTimeout(k,100);return}let e=_(),t=window.CartModal.getItems(),n=window.CartModal.calculate(t);if(o.log("Rendering cart:",t.length,"items",n),!b){let a=c('[data-flow="cart-item"]');a&&(b=a.cloneNode(!0),w=a.parentElement,a.setAttribute("data-template","original"),o.log("Cart template initialized"))}if(w&&x("[data-cloned]",w).forEach(a=>a.remove()),b&&w){let a=c('[data-template="original"]',w);t.length===0?a&&(a.style.display="none"):t.forEach((l,s)=>{let i=e[l.sku];if(!i)return;let m=n.prices.find(y=>y.sku===l.sku),d;s===0&&a?(d=a,d.style.display=""):(d=b.cloneNode(!0),d.setAttribute("data-cloned","true"),d.removeAttribute("data-template"),w.appendChild(d)),d.setAttribute("data-sku",l.sku);let h=c('[data-flow="cart-item-img"]',d);h&&(h.src=i.image,h.alt=i.name);let p=c('[data-flow="cart-item-title"]',d);p&&(p.textContent=i.name);let g=c('[data-flow="cart-item-desc"]',d);g&&(g.textContent=`${Object.keys(i.biomarkers).length} Biomarker`);let M=c('[data-flow="cart-item-price"]',d);M&&(M.textContent=A((m==null?void 0:m.final)||i.basePrice));let K=c('[data-flow="cart-item-price-unit"]',d);K&&(K.textContent="\u20AC");let E=c('[data-flow="cart-item-remove"]',d);if(E){let y=E.cloneNode(!0);E.parentNode.replaceChild(y,E),y.style.cursor="pointer",y.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),window.CartModal.remove(l.sku),f("Paket entfernt","info")})}})}let r=c('[data-flow="total-price"]');r&&(r.textContent=A(n.total));let u=c('[data-flow="total-price-unit"]');u&&(u.textContent="\u20AC"),x("[data-cart-count]").forEach(a=>a.textContent=t.length),o.log("Cart render complete. Total:",A(n.total))}let v=!1;function S(){let e=c("#choose-appointment-headline"),t=c(".w-embed.w-iframe"),n=window.Auth&&window.Auth.isAuthenticated();o.log("updateAppointmentSection, authenticated:",n),e&&(e.style.display=n?"":"none"),t&&(t.style.display=n?"":"none"),n&&t&&!v&&(B(t),v=!0),!n&&t&&(t.innerHTML="",v=!1)}function B(e){let t=window.Auth?window.Auth.getCurrentUser():null,n=(t==null?void 0:t.name)||localStorage.getItem("userName")||"",r=(t==null?void 0:t.email)||localStorage.getItem("userEmail")||"",u=n.trim().split(/\s+/),a=C.CALENDLY_BASE_URL+"?hide_gdpr_banner=1";n&&(a+="&name="+encodeURIComponent(n)),r&&(a+="&email="+encodeURIComponent(r)),e.innerHTML="";let l=document.createElement("div");l.className="calendly-inline-widget",l.setAttribute("data-url",a),l.style.cssText="min-width:100%;height:700px;",e.appendChild(l);function s(){o.log("Initializing inline Calendly widget");try{window.Calendly.initInlineWidget({url:a,parentElement:l,prefill:{firstName:u[0]||"",lastName:u.slice(1).join(" ")||"",email:r}}),o.log("Inline Calendly widget initialized")}catch(i){o.error("Calendly.initInlineWidget failed:",i);let m=document.createElement("iframe");m.src=a,m.style.cssText="width:100%;height:100%;border:none;",l.appendChild(m)}}if(window.Calendly)s();else{if(!document.querySelector('link[href*="assets.calendly.com"]')){let i=document.createElement("link");i.rel="stylesheet",i.href="https://assets.calendly.com/assets/external/widget.css",document.head.appendChild(i)}if(document.querySelector('script[src*="assets.calendly.com"]')){let i=setInterval(()=>{window.Calendly&&(clearInterval(i),s())},100);setTimeout(()=>clearInterval(i),5e3)}else{let i=document.createElement("script");i.src="https://assets.calendly.com/assets/external/widget.js",i.async=!0,i.setAttribute("data-cookieconsent","ignore"),i.onload=()=>{window.Calendly?s():o.error("widget.js loaded but window.Calendly undefined")},i.onerror=()=>{o.error("Failed to load Calendly widget.js");let m=document.createElement("iframe");m.src=a,m.style.cssText="width:100%;height:100%;border:none;",l.appendChild(m)},document.head.appendChild(i)}}}function L(){document.addEventListener("click",e=>{var m,d,h;if(!((m=e.target)==null?void 0:m.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(e.preventDefault(),e.stopPropagation(),o.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){f("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){o.error("CartModal not available");return}let n=window.CartModal.getItems();if(n.length===0){f("Warenkorb ist leer","error");return}let r=c('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),u=r==null?void 0:r.value;if(!u&&r){let p=r.nextElementSibling;if(p&&p.classList.contains("nice-select")){let g=p.querySelector(".option.selected");g&&g.getAttribute("data-value")&&(u=g.getAttribute("data-value"))}}if(!u){f("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let a=_(),l=window.CartModal.calculate(n),s=window.Auth?window.Auth.getCurrentUser():null,i={user_id:(s==null?void 0:s.id)||localStorage.getItem("userId")||"",name:(s==null?void 0:s.name)||"Guest",email:(s==null?void 0:s.email)||"",practice:((h=(d=r==null?void 0:r.options)==null?void 0:d[r.selectedIndex])==null?void 0:h.text)||u,total:l.total,packages:n.map(p=>{var g;return(g=a[p.sku])==null?void 0:g.name}).join(", "),items:n};sessionStorage.setItem("pending_booking",JSON.stringify(i)),f("Buchungsdaten gespeichert. Bitte Termin im Kalender unten w\xE4hlen.","success")},!0)}window.addEventListener("message",e=>{var t,n,r;if(e.origin&&e.origin.includes("calendly")&&o.log("Calendly postMessage received:",{origin:e.origin,event:(t=e.data)==null?void 0:t.event,data:e.data}),((n=e.data)==null?void 0:n.event)==="calendly.event_scheduled"){o.log("Booking completed!");let u=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");o.log("Booking data from session:",u);let a={event_type:"blood_test_booked",user_id:Number(u.user_id)||0,event_data:{...u,calendly_event:((r=e.data)==null?void 0:r.payload)||{}}};o.log("Sending webhook payload:",a),o.log("Webhook URL:",C.WEBHOOK_DEV),fetch(C.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":C.WEBHOOK_KEY_DEV},body:JSON.stringify(a)}).then(l=>(o.log("Webhook response:",l.status,l.statusText),l.text())).then(l=>o.log("Webhook response body:",l)).catch(l=>o.error("Webhook error:",l)),window.CartModal&&window.CartModal.clear(),f("Termin erfolgreich gebucht!","success")}});function P(){let e=c('[data-flow="cart-empty"], [data-cart="cart-empty"]');e&&(e.style.cursor="pointer",e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),window.CartModal&&window.CartModal.clear(),f("Warenkorb geleert","info")}),o.log("Clear cart button initialized"))}function I(){window.Auth&&window.Auth.updateUI()}function O(){o.log("Order page initializing"),k(),P(),L(),I(),S(),window.addEventListener("cart-updated",()=>{k()}),window.addEventListener("auth-changed",()=>{I(),S()}),o.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O()})();})();
