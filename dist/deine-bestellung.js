"use strict";(()=>{(function(){let b={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},o={log:(...t)=>b.DEBUG&&console.log("[ORDER]",...t),error:(...t)=>console.error("[ORDER]",...t)},c=(t,n=document)=>n.querySelector(t),x=(t,n=document)=>[...n.querySelectorAll(t)],C=t=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t/100);function A(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(o.error("CartModal.PACKAGES not available"),{})}function p(t,n="info"){let e=document.createElement("div");e.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${n==="success"?"#00a86b":n==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),300)},3e3)}let v=null,f=null;function k(){if(!window.CartModal){o.log("Waiting for CartModal..."),setTimeout(k,100);return}let t=A(),n=window.CartModal.getItems(),e=window.CartModal.calculate(n);if(o.log("Rendering cart:",n.length,"items",e),!v){let a=c('[data-flow="cart-item"]');a&&(v=a.cloneNode(!0),f=a.parentElement,a.setAttribute("data-template","original"),o.log("Cart template initialized"))}if(f&&x("[data-cloned]",f).forEach(a=>a.remove()),v&&f){let a=c('[data-template="original"]',f);n.length===0?a&&(a.style.display="none"):n.forEach((r,m)=>{let s=t[r.sku];if(!s)return;let w=e.prices.find(y=>y.sku===r.sku),l;m===0&&a?(l=a,l.style.display=""):(l=v.cloneNode(!0),l.setAttribute("data-cloned","true"),l.removeAttribute("data-template"),f.appendChild(l)),l.setAttribute("data-sku",r.sku);let h=c('[data-flow="cart-item-img"]',l);h&&(h.src=s.image,h.alt=s.name);let g=c('[data-flow="cart-item-title"]',l);g&&(g.textContent=s.name);let u=c('[data-flow="cart-item-desc"]',l);u&&(u.textContent=`${Object.keys(s.biomarkers).length} Biomarker`);let O=c('[data-flow="cart-item-price"]',l);O&&(O.textContent=C((w==null?void 0:w.final)||s.basePrice));let M=c('[data-flow="cart-item-price-unit"]',l);M&&(M.textContent="\u20AC");let E=c('[data-flow="cart-item-remove"]',l);if(E){let y=E.cloneNode(!0);E.parentNode.replaceChild(y,E),y.style.cursor="pointer",y.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),window.CartModal.remove(r.sku),p("Paket entfernt","info")})}})}let i=c('[data-flow="total-price"]');i&&(i.textContent=C(e.total));let d=c('[data-flow="total-price-unit"]');d&&(d.textContent="\u20AC"),x("[data-cart-count]").forEach(a=>a.textContent=n.length),o.log("Cart render complete. Total:",C(e.total))}function D(t){let n=new URLSearchParams({name:t.name,email:t.email,a1:`Praxis: ${t.practice}`,a2:`Preis: \u20AC${C(t.total)}`,a3:`Pakete: ${t.packages}`});return`${b.CALENDLY_BASE_URL}?${n}`}function K(t,n){let e=document.createElement("div");e.id="calendly-container",e.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",e.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${t}" style="flex:1;"></div>
      </div>`,document.body.appendChild(e);let i=e.querySelector(".calendly-inline-widget"),d=document.createElement("iframe");d.src=t,d.style.cssText="width:100%;height:100%;border:none;",d.setAttribute("frameborder","0"),i.appendChild(d),o.log("Calendly iframe injected:",t)}function B(){document.addEventListener("click",t=>{var w,l,h;if(!((w=t.target)==null?void 0:w.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(t.preventDefault(),t.stopPropagation(),o.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){p("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){o.error("CartModal not available");return}let e=window.CartModal.getItems();if(e.length===0){p("Warenkorb ist leer","error");return}let i=c('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),d=i==null?void 0:i.value;if(!d&&i){let g=i.nextElementSibling;if(g&&g.classList.contains("nice-select")){let u=g.querySelector(".option.selected");u&&u.getAttribute("data-value")&&(d=u.getAttribute("data-value"))}}if(!d){p("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let a=A(),r=window.CartModal.calculate(e),m=window.Auth?window.Auth.getCurrentUser():null,s={name:(m==null?void 0:m.name)||"Guest",email:(m==null?void 0:m.email)||"",practice:((h=(l=i==null?void 0:i.options)==null?void 0:l[i.selectedIndex])==null?void 0:h.text)||d,total:r.total,packages:e.map(g=>{var u;return(u=a[g.sku])==null?void 0:u.name}).join(", "),items:e};sessionStorage.setItem("pending_booking",JSON.stringify(s)),K(D(s),s)},!0)}window.addEventListener("message",t=>{var n,e,i;if(t.origin&&t.origin.includes("calendly")&&o.log("Calendly postMessage received:",{origin:t.origin,event:(n=t.data)==null?void 0:n.event,data:t.data}),((e=t.data)==null?void 0:e.event)==="calendly.event_scheduled"){o.log("Booking completed!");let d=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");o.log("Booking data from session:",d);let a={event_type:"blood_test_booked",event_data:{...d,calendly_event:((i=t.data)==null?void 0:i.payload)||{}}};o.log("Sending webhook payload:",a),o.log("Webhook URL:",b.WEBHOOK_DEV),fetch(b.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":b.WEBHOOK_KEY_DEV},body:JSON.stringify(a)}).then(r=>(o.log("Webhook response:",r.status,r.statusText),r.text())).then(r=>o.log("Webhook response body:",r)).catch(r=>o.error("Webhook error:",r)),window.CartModal&&window.CartModal.clear(),p("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var r;return(r=document.getElementById("calendly-container"))==null?void 0:r.remove()},2e3)}});function L(){let t=c('[data-flow="cart-empty"], [data-cart="cart-empty"]');t&&(t.style.cursor="pointer",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),window.CartModal&&window.CartModal.clear(),p("Warenkorb geleert","info")}),o.log("Clear cart button initialized"))}function _(){window.Auth&&window.Auth.updateUI()}function S(){o.log("Order page initializing"),k(),L(),B(),_(),window.addEventListener("cart-updated",()=>{k()}),window.addEventListener("auth-changed",()=>{_()}),o.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();})();
