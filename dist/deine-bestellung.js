"use strict";(()=>{(function(){let y={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},r={log:(...t)=>y.DEBUG&&console.log("[ORDER]",...t),error:(...t)=>console.error("[ORDER]",...t)},l=(t,n=document)=>n.querySelector(t),k=(t,n=document)=>[...n.querySelectorAll(t)],C=t=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t/100);function A(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(r.error("CartModal.PACKAGES not available"),{})}function p(t,n="info"){let e=document.createElement("div");e.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${n==="success"?"#00a86b":n==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),300)},3e3)}let E=null,f=null;function v(){if(!window.CartModal){r.log("Waiting for CartModal..."),setTimeout(v,100);return}let t=A(),n=window.CartModal.getItems(),e=window.CartModal.calculate(n);if(r.log("Rendering cart:",n.length,"items",e),!E){let o=l('[data-flow="cart-item"]');o&&(E=o.cloneNode(!0),f=o.parentElement,o.setAttribute("data-template","original"),r.log("Cart template initialized"))}if(f&&k("[data-cloned]",f).forEach(o=>o.remove()),E&&f){let o=l('[data-template="original"]',f);n.length===0?o&&(o.style.display="none"):n.forEach((g,u)=>{let d=t[g.sku];if(!d)return;let w=e.prices.find(b=>b.sku===g.sku),a;u===0&&o?(a=o,a.style.display=""):(a=E.cloneNode(!0),a.setAttribute("data-cloned","true"),a.removeAttribute("data-template"),f.appendChild(a)),a.setAttribute("data-sku",g.sku);let h=l('[data-flow="cart-item-img"]',a);h&&(h.src=d.image,h.alt=d.name);let m=l('[data-flow="cart-item-title"]',a);m&&(m.textContent=d.name);let s=l('[data-flow="cart-item-desc"]',a);s&&(s.textContent=`${Object.keys(d.biomarkers).length} Biomarker`);let O=l('[data-flow="cart-item-price"]',a);O&&(O.textContent=C((w==null?void 0:w.final)||d.basePrice));let P=l('[data-flow="cart-item-price-unit"]',a);P&&(P.textContent="\u20AC");let x=l('[data-flow="cart-item-remove"]',a);if(x){let b=x.cloneNode(!0);x.parentNode.replaceChild(b,x),b.style.cursor="pointer",b.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation(),window.CartModal.remove(g.sku),p("Paket entfernt","info")})}})}let i=l('[data-flow="total-price"]');i&&(i.textContent=C(e.total));let c=l('[data-flow="total-price-unit"]');c&&(c.textContent="\u20AC"),k("[data-cart-count]").forEach(o=>o.textContent=n.length),r.log("Cart render complete. Total:",C(e.total))}function D(t){let n=new URLSearchParams({name:t.name,email:t.email,a1:`Praxis: ${t.practice}`,a2:`Preis: \u20AC${C(t.total)}`,a3:`Pakete: ${t.packages}`});return`${y.CALENDLY_BASE_URL}?${n}`}function K(t,n){let e=document.createElement("div");e.id="calendly-container",e.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",e.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${t}" style="flex:1;"></div>
      </div>`,document.body.appendChild(e);let i=e.querySelector(".calendly-inline-widget");function c(){window.Calendly&&window.Calendly.initInlineWidget({url:t,parentElement:i,prefill:{name:n.name,email:n.email}})}if(window.Calendly)c();else{let o=document.createElement("script");o.src="https://assets.calendly.com/assets/external/widget.js",o.async=!0,o.onload=c,document.body.appendChild(o)}}function L(){document.addEventListener("click",t=>{var w,a,h;if(!((w=t.target)==null?void 0:w.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(t.preventDefault(),t.stopPropagation(),r.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){p("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){r.error("CartModal not available");return}let e=window.CartModal.getItems();if(e.length===0){p("Warenkorb ist leer","error");return}let i=l('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),c=i==null?void 0:i.value;if(!c&&i){let m=i.nextElementSibling;if(m&&m.classList.contains("nice-select")){let s=m.querySelector(".option.selected");s&&s.getAttribute("data-value")&&(c=s.getAttribute("data-value"))}}if(!c){p("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let o=A(),g=window.CartModal.calculate(e),u=window.Auth?window.Auth.getCurrentUser():null,d={name:(u==null?void 0:u.name)||"Guest",email:(u==null?void 0:u.email)||"",practice:((h=(a=i==null?void 0:i.options)==null?void 0:a[i.selectedIndex])==null?void 0:h.text)||c,total:g.total,packages:e.map(m=>{var s;return(s=o[m.sku])==null?void 0:s.name}).join(", "),items:e};sessionStorage.setItem("pending_booking",JSON.stringify(d)),K(D(d),d)},!0)}window.addEventListener("message",t=>{if(t.data.event==="calendly.event_scheduled"){r.log("Booking completed");let n=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");fetch(y.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":y.WEBHOOK_KEY_DEV},body:JSON.stringify({event_type:"blood_test_booked",event_data:n})}).catch(e=>r.error("Webhook error:",e)),window.CartModal&&window.CartModal.clear(),p("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var e;return(e=document.getElementById("calendly-container"))==null?void 0:e.remove()},2e3)}});function B(){let t=l('[data-flow="cart-empty"], [data-cart="cart-empty"]');t&&(t.style.cursor="pointer",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),window.CartModal&&window.CartModal.clear(),p("Warenkorb geleert","info")}),r.log("Clear cart button initialized"))}function _(){window.Auth&&window.Auth.updateUI()}function S(){r.log("Order page initializing"),v(),B(),L(),_(),window.addEventListener("cart-updated",()=>{v()}),window.addEventListener("auth-changed",()=>{_()}),r.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();})();
