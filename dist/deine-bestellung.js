"use strict";(()=>{(function(){let y={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},i={log:(...t)=>y.DEBUG&&console.log("[ORDER]",...t),error:(...t)=>console.error("[ORDER]",...t)},r=(t,n=document)=>n.querySelector(t),k=(t,n=document)=>[...n.querySelectorAll(t)],C=t=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t/100);function A(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(i.error("CartModal.PACKAGES not available"),{})}function p(t,n="info"){let e=document.createElement("div");e.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${n==="success"?"#00a86b":n==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),300)},3e3)}let E=null,f=null;function x(){if(!window.CartModal){i.log("Waiting for CartModal..."),setTimeout(x,100);return}let t=A(),n=window.CartModal.getItems(),e=window.CartModal.calculate(n);if(i.log("Rendering cart:",n.length,"items",e),!E){let a=r('[data-flow="cart-item"]');a&&(E=a.cloneNode(!0),f=a.parentElement,a.setAttribute("data-template","original"),i.log("Cart template initialized"))}if(f&&k("[data-cloned]",f).forEach(a=>a.remove()),E&&f){let a=r('[data-template="original"]',f);n.length===0?a&&(a.style.display="none"):n.forEach((g,s)=>{let c=t[g.sku];if(!c)return;let w=e.prices.find(b=>b.sku===g.sku),o;s===0&&a?(o=a,o.style.display=""):(o=E.cloneNode(!0),o.setAttribute("data-cloned","true"),o.removeAttribute("data-template"),f.appendChild(o)),o.setAttribute("data-sku",g.sku);let h=r('[data-flow="cart-item-img"]',o);h&&(h.src=c.image,h.alt=c.name);let u=r('[data-flow="cart-item-title"]',o);u&&(u.textContent=c.name);let d=r('[data-flow="cart-item-desc"]',o);d&&(d.textContent=`${Object.keys(c.biomarkers).length} Biomarker`);let O=r('[data-flow="cart-item-price"]',o);O&&(O.textContent=C((w==null?void 0:w.final)||c.basePrice));let P=r('[data-flow="cart-item-price-unit"]',o);P&&(P.textContent="\u20AC");let v=r('[data-flow="cart-item-remove"]',o);if(v){let b=v.cloneNode(!0);v.parentNode.replaceChild(b,v),b.style.cursor="pointer",b.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation(),window.CartModal.remove(g.sku),p("Paket entfernt","info")})}})}let l=r('[data-flow="total-price"]');l&&(l.textContent=C(e.total));let m=r('[data-flow="total-price-unit"]');m&&(m.textContent="\u20AC"),k("[data-cart-count]").forEach(a=>a.textContent=n.length),i.log("Cart render complete. Total:",C(e.total))}function D(t){let n=new URLSearchParams({name:t.name,email:t.email,a1:`Praxis: ${t.practice}`,a2:`Preis: \u20AC${C(t.total)}`,a3:`Pakete: ${t.packages}`});return`${y.CALENDLY_BASE_URL}?${n}`}function K(t,n){let e=document.createElement("div");e.id="calendly-container",e.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",e.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${t}" style="flex:1;"></div>
      </div>`,document.body.appendChild(e),window.Calendly&&Calendly.initInlineWidget({url:t,parentElement:e.querySelector(".calendly-inline-widget"),prefill:{name:n.name,email:n.email}})}function L(){document.addEventListener("click",t=>{var w,o,h;if(!((w=t.target)==null?void 0:w.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(t.preventDefault(),t.stopPropagation(),i.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){p("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){i.error("CartModal not available");return}let e=window.CartModal.getItems();if(e.length===0){p("Warenkorb ist leer","error");return}let l=r('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),m=l==null?void 0:l.value;if(!m&&l){let u=l.nextElementSibling;if(u&&u.classList.contains("nice-select")){let d=u.querySelector(".option.selected");d&&d.getAttribute("data-value")&&(m=d.getAttribute("data-value"))}}if(!m){p("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let a=A(),g=window.CartModal.calculate(e),s=window.Auth?window.Auth.getCurrentUser():null,c={name:(s==null?void 0:s.name)||"Guest",email:(s==null?void 0:s.email)||"",practice:((h=(o=l==null?void 0:l.options)==null?void 0:o[l.selectedIndex])==null?void 0:h.text)||m,total:g.total,packages:e.map(u=>{var d;return(d=a[u.sku])==null?void 0:d.name}).join(", "),items:e};sessionStorage.setItem("pending_booking",JSON.stringify(c)),K(D(c),c)},!0)}window.addEventListener("message",t=>{if(t.data.event==="calendly.event_scheduled"){i.log("Booking completed");let n=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");fetch(y.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":y.WEBHOOK_KEY_DEV},body:JSON.stringify({event_type:"blood_test_booked",event_data:n})}).catch(e=>i.error("Webhook error:",e)),window.CartModal&&window.CartModal.clear(),p("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var e;return(e=document.getElementById("calendly-container"))==null?void 0:e.remove()},2e3)}});function B(){let t=r('[data-flow="cart-empty"], [data-cart="cart-empty"]');t&&(t.style.cursor="pointer",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),window.CartModal&&window.CartModal.clear(),p("Warenkorb geleert","info")}),i.log("Clear cart button initialized"))}function _(){window.Auth&&window.Auth.updateUI()}function S(){i.log("Order page initializing"),x(),B(),L(),_(),window.addEventListener("cart-updated",()=>{x()}),window.addEventListener("auth-changed",()=>{_()}),i.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();})();
