"use strict";(()=>{(function(){let h={DEBUG:!0,WEBHOOK_DEV:"https://lth-rec2-dev.orangegrass-967fbaa9.germanywestcentral.azurecontainerapps.io/api/v2/events/",WEBHOOK_KEY_DEV:"1KsF2jui1P9yUkL2SdvskKGjAqT2eaOCQKraY5wZaVbOfkROvtXeYdj6ZjUSSa0Q9dK7t5qzGK9ytKclSHl_qg",CALENDLY_BASE_URL:"https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest",PACKAGE_IDS:{longterm_health:1001,womens_health:1002,mens_health:1003,chronic_inflammation:1004,iron_metabolism:1005,heart_health:1006,vitamin_b_metabolism:1007,vitamin_d:1008}},n={log:(...e)=>h.DEBUG&&console.log("[ORDER]",...e),error:(...e)=>console.error("[ORDER]",...e)},d=(e,a=document)=>a.querySelector(e),k=(e,a=document)=>[...a.querySelectorAll(e)],b=e=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e/100);function A(){return window.CartModal&&window.CartModal.PACKAGES?window.CartModal.PACKAGES:(n.error("CartModal.PACKAGES not available"),{})}function p(e,a="info"){let t=document.createElement("div");t.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${a==="success"?"#00a86b":a==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>t.remove(),300)},3e3)}let v=null,w=null;function E(){if(!window.CartModal){n.log("Waiting for CartModal..."),setTimeout(E,100);return}let e=A(),a=window.CartModal.getItems(),t=window.CartModal.calculate(a);if(n.log("Rendering cart:",a.length,"items",t),!v){let o=d('[data-flow="cart-item"]');o&&(v=o.cloneNode(!0),w=o.parentElement,o.setAttribute("data-template","original"),n.log("Cart template initialized"))}if(w&&k("[data-cloned]",w).forEach(o=>o.remove()),v&&w){let o=d('[data-template="original"]',w);a.length===0?o&&(o.style.display="none"):a.forEach((r,s)=>{let u=e[r.sku];if(!u)return;let f=t.prices.find(C=>C.sku===r.sku),i;s===0&&o?(i=o,i.style.display=""):(i=v.cloneNode(!0),i.setAttribute("data-cloned","true"),i.removeAttribute("data-template"),w.appendChild(i)),i.setAttribute("data-sku",r.sku);let y=d('[data-flow="cart-item-img"]',i);y&&(y.src=u.image,y.alt=u.name);let g=d('[data-flow="cart-item-title"]',i);g&&(g.textContent=u.name);let m=d('[data-flow="cart-item-desc"]',i);m&&(m.textContent=`${Object.keys(u.biomarkers).length} Biomarker`);let O=d('[data-flow="cart-item-price"]',i);O&&(O.textContent=b((f==null?void 0:f.final)||u.basePrice));let P=d('[data-flow="cart-item-price-unit"]',i);P&&(P.textContent="\u20AC");let x=d('[data-flow="cart-item-remove"]',i);if(x){let C=x.cloneNode(!0);x.parentNode.replaceChild(C,x),C.style.cursor="pointer",C.addEventListener("click",L=>{L.preventDefault(),L.stopPropagation(),window.CartModal.remove(r.sku),p("Paket entfernt","info")})}})}let l=d('[data-flow="total-price"]');l&&(l.textContent=b(t.total));let c=d('[data-flow="total-price-unit"]');c&&(c.textContent="\u20AC"),k("[data-cart-count]").forEach(o=>o.textContent=a.length),n.log("Cart render complete. Total:",b(t.total))}function M(e){let a=new URLSearchParams({name:e.name,email:e.email,a1:`Praxis: ${e.practice}`,a2:`Preis: \u20AC${b(e.total)}`,a3:`Pakete: ${e.packages}`});return`${h.CALENDLY_BASE_URL}?${a}`}function D(e,a){let t=document.createElement("div");t.id="calendly-container",t.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;",t.innerHTML=`
      <div style="width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;">Termin buchen</h3>
          <button onclick="document.getElementById('calendly-container').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">\xD7</button>
        </div>
        <div class="calendly-inline-widget" data-url="${e}" style="flex:1;"></div>
      </div>`,document.body.appendChild(t);let l=t.querySelector(".calendly-inline-widget");n.log("Calendly widget element:",l),n.log("Calendly URL:",e),n.log("window.Calendly available:",!!window.Calendly);function c(){if(n.log("initWidget called, window.Calendly:",!!window.Calendly),window.Calendly)try{window.Calendly.initInlineWidget({url:e,parentElement:l,prefill:{name:a.name,email:a.email}}),n.log("Calendly.initInlineWidget called successfully")}catch(o){n.error("Calendly.initInlineWidget error:",o)}else n.error("window.Calendly still not available after script load")}if(window.Calendly)c();else if(n.log("Loading Calendly widget script..."),document.querySelector('script[src*="assets.calendly.com"]')){n.log("Calendly script tag exists but Calendly not ready, waiting...");let r=setInterval(()=>{window.Calendly&&(clearInterval(r),c())},100);setTimeout(()=>clearInterval(r),1e4)}else{let r=document.createElement("script");r.src="https://assets.calendly.com/assets/external/widget.js",r.async=!0,r.onload=()=>{n.log("Calendly script loaded"),c()},r.onerror=s=>{n.error("Failed to load Calendly script:",s)},document.body.appendChild(r)}}function I(){document.addEventListener("click",e=>{var f,i,y;if(!((f=e.target)==null?void 0:f.closest('[data-flow="btn-buy"], [data-cart="btn-buy"], [data-cart="checkout"]')))return;if(e.preventDefault(),e.stopPropagation(),n.log("Checkout clicked"),window.Auth&&!window.Auth.isAuthenticated()){p("Bitte melden Sie sich an","info"),window.Auth.openModal();return}if(!window.CartModal){n.error("CartModal not available");return}let t=window.CartModal.getItems();if(t.length===0){p("Warenkorb ist leer","error");return}let l=d('#Praxis, [data-flow="practice-select"], #doctor-practice-select, select[name="Praxis"], select[name="practice"], select[name="doctor"]'),c=l==null?void 0:l.value;if(!c&&l){let g=l.nextElementSibling;if(g&&g.classList.contains("nice-select")){let m=g.querySelector(".option.selected");m&&m.getAttribute("data-value")&&(c=m.getAttribute("data-value"))}}if(!c){p("Bitte w\xE4hlen Sie eine Arztpraxis","error");return}let o=A(),r=window.CartModal.calculate(t),s=window.Auth?window.Auth.getCurrentUser():null,u={name:(s==null?void 0:s.name)||"Guest",email:(s==null?void 0:s.email)||"",practice:((y=(i=l==null?void 0:l.options)==null?void 0:i[l.selectedIndex])==null?void 0:y.text)||c,total:r.total,packages:t.map(g=>{var m;return(m=o[g.sku])==null?void 0:m.name}).join(", "),items:t};sessionStorage.setItem("pending_booking",JSON.stringify(u)),D(M(u),u)},!0)}window.addEventListener("message",e=>{if(e.data.event==="calendly.event_scheduled"){n.log("Booking completed");let a=JSON.parse(sessionStorage.getItem("pending_booking")||"{}");fetch(h.WEBHOOK_DEV,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":h.WEBHOOK_KEY_DEV},body:JSON.stringify({event_type:"blood_test_booked",event_data:a})}).catch(t=>n.error("Webhook error:",t)),window.CartModal&&window.CartModal.clear(),p("Termin erfolgreich gebucht!","success"),setTimeout(()=>{var t;return(t=document.getElementById("calendly-container"))==null?void 0:t.remove()},2e3)}});function K(){let e=d('[data-flow="cart-empty"], [data-cart="cart-empty"]');e&&(e.style.cursor="pointer",e.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),window.CartModal&&window.CartModal.clear(),p("Warenkorb geleert","info")}),n.log("Clear cart button initialized"))}function _(){window.Auth&&window.Auth.updateUI()}function S(){n.log("Order page initializing"),E(),K(),I(),_(),window.addEventListener("cart-updated",()=>{E()}),window.addEventListener("auth-changed",()=>{_()}),n.log("Order page ready")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();})();
