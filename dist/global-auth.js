"use strict";(()=>{(function(){let Z={API_BASE:"https://bluesphere.dev.longtermhealth.de",DEBUG:!1},w={TOKEN_KEY:"auth_token",REFRESH_KEY:"refresh_token",USER_KEY:"user_data"},l={log:(...e)=>Z.DEBUG&&console.log("[AUTH]",...e),error:(...e)=>console.error("[AUTH]",...e)},d=(e,n=document)=>n.querySelector(e),x=(e,n=document)=>[...n.querySelectorAll(e)],E={set:function(e,n,i=60){let r={value:n,expiry:new Date().getTime()+i*60*1e3};try{sessionStorage.setItem(e,JSON.stringify(r))}catch(u){l.error("Storage error:",u)}},get:function(e){try{let n=sessionStorage.getItem(e);if(!n)return null;let i=JSON.parse(n);return new Date().getTime()>i.expiry?(sessionStorage.removeItem(e),null):i.value}catch{return null}},remove:function(e){sessionStorage.removeItem(e)}};async function q(e,n={}){let i=Z.API_BASE+e,r=E.get(w.TOKEN_KEY),u={"Content-Type":"application/json",...n.headers};r&&(u.Authorization=`Bearer ${r}`),l.log("API Call:",e,n.method||"GET");try{let g=await fetch(i,{...n,headers:u});return l.log("API Response:",g.status),g}catch(g){throw l.error("API error:",g),g}}let H={firstName:"",lastName:"",email:"",password:""},ie={male:"MALE",female:"FEMALE",diverse:"OTHER","non-binary":"NON_BINARY",other:"OTHER","no-share":"NO_SHARE",unknown:"UNKNOWN",MALE:"MALE",FEMALE:"FEMALE",NON_BINARY:"NON_BINARY",OTHER:"OTHER",NO_SHARE:"NO_SHARE",UNKNOWN:"UNKNOWN"};async function re(e){let{firstName:n,lastName:i,email:r,password:u,dateOfBirth:g,gender:f}=e;l.log("Registering user:",r);let p=ie[f]||ie[f.toLowerCase()]||"UNKNOWN",m={firstName:n.trim(),lastName:i.trim(),email:r.toLowerCase().trim(),password:u,dateOfBirth:g,gender:p,role:"PATIENT"},h=await q("/user/registration",{method:"POST",body:JSON.stringify(m)});if(!h.ok){let K=await h.json().catch(()=>({}));throw new Error(K.statusMessage||K.message||"Registrierung fehlgeschlagen")}let N=await h.json();return l.log("Registration successful:",N),E.set(w.USER_KEY,{name:`${n} ${i}`,email:r,id:N.userId||N.id}),N}async function ae(e,n){l.log("Logging in user:",e);let i=await q("/user/login",{method:"POST",body:JSON.stringify({email:e.toLowerCase().trim(),password:n})});if(!i.ok){let h=await i.json().catch(()=>({}));throw new Error(h.statusMessage||h.message||"Anmeldung fehlgeschlagen")}let r=await i.json();l.log("Login response:",r);let u=r.result||r,g=u.user||u,f=u.token||u.accessToken||r.token||r.accessToken,p=u.refreshToken||r.refreshToken;f?(E.set(w.TOKEN_KEY,f),l.log("Token stored")):l.log("Warning: No token in login response"),p&&E.set(w.REFRESH_KEY,p,60*24*7);let m={name:g.firstName?`${g.firstName} ${g.lastName}`:g.name,email:g.email||e,id:g.id};return E.set(w.USER_KEY,m),localStorage.setItem("userName",m.name),localStorage.setItem("userEmail",m.email),localStorage.setItem("userId",String(m.id)),l.log("Login successful"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),g}async function se(e){l.log("Verifying email with code:",e);let n=await q("/user/confirmation",{method:"POST",body:JSON.stringify({code:e.trim()})});if(!n.ok&&n.status!==201){let r=await n.json().catch(()=>({}));throw new Error(r.statusMessage||r.message||"Verifizierung fehlgeschlagen")}let i=await n.json();return l.log("Verification successful:",i),(i.token||i.accessToken)&&E.set(w.TOKEN_KEY,i.token||i.accessToken),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),i}async function le(){l.log("Resending verification code");let e=E.get(w.USER_KEY);if(!(e!=null&&e.email))throw new Error("Keine E-Mail-Adresse gefunden");let n=await q("/user/verification-code-resend",{method:"POST",body:JSON.stringify({email:e.email})});if(!n.ok){let i=await n.json().catch(()=>({}));throw new Error(i.statusMessage||i.message||"Code konnte nicht gesendet werden")}return!0}function ee(){let e=E.get(w.TOKEN_KEY),n=E.get(w.USER_KEY);return!!(e||n)}function j(){return E.get(w.USER_KEY)}function de(){E.remove(w.TOKEN_KEY),E.remove(w.REFRESH_KEY),E.remove(w.USER_KEY),localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userId"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!1}})),l.log("User logged out")}let _e=0,ce="login";function ue(){return d('[data-modal-name="register"]')}function D(){let e=ue();return e?x('[data-register="form-step"]',e):x('[data-register="form-step"]')}function F(e){D().forEach((i,r)=>{i.style.display=r===e?"block":"none"}),_e=e,l.log("Showing step:",e)}function te(){let e=D();for(let n=0;n<e.length;n++)if(e[n].getAttribute("data-register-type")==="register"){F(n),ce="register";return}}function Y(){let e=D();for(let n=0;n<e.length;n++)if((e[n].getAttribute("data-registe-type")||e[n].getAttribute("data-register-type"))==="sign-in"){F(n),ce="login";return}}function Ce(){let e=D();for(let n=0;n<e.length;n++)if(e[n].getAttribute("data-register-type")==="personal-info"){F(n),setTimeout(()=>{let r=e[n].querySelector('input[data-toggle="datepicker"]');if(l.log("Personal-info step: datepicker input:",r?"found":"not found"),r){let g=function(){if(!window.jQuery)return;let m=window.jQuery(r);if(typeof m.datepicker!="function"){l.log("Datepicker plugin not loaded, loading...");let h=document.createElement("link");h.rel="stylesheet",h.href="https://cdn.jsdelivr.net/npm/@chenfengyuan/datepicker@1/dist/datepicker.min.css",document.head.appendChild(h);let N=document.createElement("script");N.src="https://cdn.jsdelivr.net/npm/@chenfengyuan/datepicker@1/dist/datepicker.min.js",N.onload=()=>{window.jQuery(r).datepicker({format:"dd.mm.yyyy",autoHide:!0}),l.log("Datepicker loaded and initialized")},document.head.appendChild(N)}else m.data("datepicker")?l.log("Datepicker already initialized"):(m.datepicker({format:"dd.mm.yyyy",autoHide:!0}),l.log("Datepicker initialized"))};var u=g;g();let f=r.closest(".form_field"),p=f==null?void 0:f.querySelector(".form_field-icon");l.log("Calendar icon:",p?"found":"not found"),p&&!p._dpBound&&(p._dpBound=!0,p.style.cursor="pointer",p.addEventListener("click",m=>{if(m.preventDefault(),m.stopPropagation(),l.log("Calendar icon clicked"),r.focus(),window.jQuery)try{let h=window.jQuery(r);l.log("datepicker data:",!!h.data("datepicker"),"fn:",typeof h.datepicker),h.datepicker("show")}catch(h){l.log("datepicker show error:",h.message)}}))}},200);return}}function Ne(){let e=D();for(let n=0;n<e.length;n++)if(e[n].getAttribute("data-register-type")==="code"){F(n);return}}function ge(){F(0)}function V(e){if(l.log("Opening register modal, step:",e||"initial"),typeof window.openModal=="function")window.openModal("register");else{let n=d('[data-modal-target="register"]'),i=d('[data-modal-name="register"]'),r=d("[data-modal-group-status]");n&&n.setAttribute("data-modal-status","active"),i&&i.setAttribute("data-modal-status","active"),r&&r.setAttribute("data-modal-group-status","active")}setTimeout(()=>{e==="register"?te():e==="login"?Y():ge()},100)}function ne(){if(typeof window.closeAllModals=="function")window.closeAllModals();else{let e=d('[data-modal-target="register"]'),n=d('[data-modal-name="register"]'),i=d("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","not-active"),n&&n.setAttribute("data-modal-status","not-active"),i&&i.setAttribute("data-modal-group-status","not-active")}}function b(e,n){let i=e.querySelector(".auth-error-message");if(!i){i=document.createElement("div"),i.className="auth-error-message",i.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;";let r=e.querySelector(".form_field-wrap");r?r.parentNode.insertBefore(i,r):e.prepend(i)}i.textContent=n,i.style.display="block",setTimeout(()=>{i.style.display="none"},5e3)}function J(){x(".auth-error-message").forEach(e=>e.style.display="none"),x(".form_validation.show").forEach(e=>e.classList.remove("show")),x(".form_field.error").forEach(e=>e.classList.remove("error"))}function A(e,n){n?(e.setAttribute("data-loading","true"),e.style.opacity="0.7",e.style.pointerEvents="none"):(e.removeAttribute("data-loading"),e.style.opacity="1",e.style.pointerEvents="auto")}function T(e,n="info"){var u;let i=((u=document.querySelector(".navbar"))==null?void 0:u.getBoundingClientRect().bottom)||80,r=document.createElement("div");r.style.cssText=`position:fixed;top:${i+8}px;right:20px;padding:16px 24px;background:${n==="success"?"#00a86b":n==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,r.textContent=e,document.body.appendChild(r),setTimeout(()=>{r.style.opacity="0",setTimeout(()=>r.remove(),300)},3e3)}function Ae(){l.log("Setting up auth handlers");let e=ue();if(!e){l.log("Register modal not found");return}let n=d('[data-register="form-wrap"]',e);if(!n){l.log("Auth form not found in register modal");return}l.log("Found form in register modal"),e.querySelectorAll('input[type="password"], input[data-toggle="datepicker"]').forEach(t=>{let o=t.closest(".form_field");if(o&&!o.querySelector(".form_label")){let a=document.createElement("label");a.className="form_label",a.setAttribute("for",t.id||""),a.textContent=t.placeholder||"",o.appendChild(a)}}),n.addEventListener("submit",t=>{t.preventDefault()});let i=d('[data-register="email-signin"]',e);i&&i.addEventListener("click",t=>{t.preventDefault(),l.log("Email signin clicked"),Y()}),x('[data-register="register-link"]',e).forEach(t=>{t.addEventListener("click",o=>{o.preventDefault(),l.log("Register link clicked"),te()})}),x('[data-register="login-link"]',e).forEach(t=>{t.addEventListener("click",o=>{o.preventDefault(),l.log("Login link clicked"),Y()})}),x('[data-register="btn-back"]',e).forEach(t=>{t.addEventListener("click",o=>{o.preventDefault(),l.log("Back button clicked");let a=t.closest('[data-register="form-step"]');a&&a.getAttribute("data-register-type")==="personal-info"?te():ge()})});let f=d('[data-register="btn-next"]',e);function p(){var t,o,a,s,c;return{firstName:((t=d("#first_name",e)||d('input[name="first_name"]',e))==null?void 0:t.value)||"",lastName:((o=d("#last_name",e)||d('input[name="last_name"]',e))==null?void 0:o.value)||"",email:((a=d("#email-sign-in",e)||d('input[name="email-sign-in"]',e))==null?void 0:a.value)||"",password:((s=d("#password-signin",e)||d('input[name="password-signin"]',e))==null?void 0:s.value)||"",passwordConfirm:((c=d("#password-signin-again",e)||d('input[name="password-signin-again"]',e))==null?void 0:c.value)||""}}function m(t,o){let a=t.closest(".form_field-wrap");if(!a)return;let s=a.querySelector(".form_field");s&&s.classList.add("error");let c=a.querySelector(".form_validation");c&&(c.textContent=o,c.classList.add("show"))}function h(t){let o=t.closest(".form_field-wrap");if(!o)return;let a=o.querySelector(".form_field");a&&a.classList.remove("error");let s=o.querySelector(".form_validation");s&&s.classList.remove("show")}function N(t){if(!t)return;let o=t.value;o&&(o.length<8||!/[A-Z]/.test(o)||!/[a-z]/.test(o)||!/[0-9]/.test(o)||!/[^A-Za-z0-9]/.test(o)?m(t,"Mindestens 8 Zeichen, Gro\xDF-/Kleinbuchstabe, Zahl und Sonderzeichen"):h(t))}function K(t,o){if(!t||!o)return;let a=t.value;a&&(a!==o.value?m(t,"Passw\xF6rter stimmen nicht \xFCberein"):h(t))}function Me(){let t=p();return!(!t.firstName||!t.lastName||!t.email||!t.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)||!t.password||t.password.length<8||!/[A-Z]/.test(t.password)||!/[a-z]/.test(t.password)||!/[0-9]/.test(t.password)||!/[^A-Za-z0-9]/.test(t.password)||t.password!==t.passwordConfirm)}function he(){if(!f)return;let t=Me();f.style.opacity=t?"":"0.5",f.style.pointerEvents=t?"auto":"none"}let R=e.querySelector('[data-register-type="register"]');if(R){R.addEventListener("input",he),he();let t=R.querySelector('#first_name, input[name="first_name"]'),o=R.querySelector('#last_name, input[name="last_name"]'),a=R.querySelector('#email-sign-in, input[name="email-sign-in"]'),s=R.querySelector('#password-signin, input[name="password-signin"]'),c=R.querySelector('#password-signin-again, input[name="password-signin-again"]');t&&t.addEventListener("input",()=>{t.value.trim()&&h(t)}),o&&o.addEventListener("input",()=>{o.value.trim()&&h(o)}),a&&a.addEventListener("input",()=>{a.value&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.value)&&h(a)}),s&&s.addEventListener("input",()=>{N(s),c&&c.value&&K(c,s)}),c&&c.addEventListener("input",()=>K(c,s)),t&&t.addEventListener("blur",()=>{t.value.trim()||m(t,"Bitte Vornamen eingeben")}),o&&o.addEventListener("blur",()=>{o.value.trim()||m(o,"Bitte Nachnamen eingeben")}),a&&a.addEventListener("blur",()=>{a.value?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.value)||m(a,"Bitte g\xFCltige E-Mail eingeben"):m(a,"Bitte E-Mail eingeben")}),s&&s.addEventListener("blur",()=>N(s)),c&&c.addEventListener("blur",()=>{c.value?K(c,s):m(c,"Bitte Passwort best\xE4tigen")})}f&&f.addEventListener("click",t=>{var C,S,B,O,_,v,L,P,xe,Le;t.preventDefault(),l.log("Next button clicked (register step 1)"),J();let o=((C=d("#first_name",e))==null?void 0:C.value)||((S=d('input[name="first_name"]',e))==null?void 0:S.value)||"",a=((B=d("#last_name",e))==null?void 0:B.value)||((O=d('input[name="last_name"]',e))==null?void 0:O.value)||"",s=((_=d("#email-sign-in",e))==null?void 0:_.value)||((v=d('input[name="email-sign-in"]',e))==null?void 0:v.value)||"",c=((L=d("#password-signin",e))==null?void 0:L.value)||((P=d('input[name="password-signin"]',e))==null?void 0:P.value)||"",y=((xe=d("#password-signin-again",e))==null?void 0:xe.value)||((Le=d('input[name="password-signin-again"]',e))==null?void 0:Le.value)||"";if(l.log("Form values:",{firstName:o,lastName:a,email:s,hasPassword:!!c}),!o||!a){b(n,"Bitte Vor- und Nachnamen eingeben");return}if(!s||!s.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){b(n,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}if(!c||c.length<8||!/[A-Z]/.test(c)||!/[a-z]/.test(c)||!/[0-9]/.test(c)||!/[^A-Za-z0-9]/.test(c)){b(n,"Passwort: min. 8 Zeichen, 1 Gro\xDFbuchstabe, 1 Kleinbuchstabe, 1 Zahl und 1 Sonderzeichen");return}if(c!==y){b(n,"Passw\xF6rter stimmen nicht \xFCberein");return}H={firstName:o,lastName:a,email:s,password:c},Ce()});let I=d('[data-register="btn-send"]',e),k=e.querySelector('[data-register-type="personal-info"]');function oe(){if(!k)return"";let t=d("select",k),o=(t==null?void 0:t.value)||"";if(!o&&t){let a=t.nextElementSibling;if(a&&a.classList.contains("nice-select")){let s=a.querySelector(".option.selected");s&&s.getAttribute("data-value")&&(o=s.getAttribute("data-value"))}}return o}function $(t){return t?/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(t):!1}function ze(){var a;if(!k)return!1;let t=((a=d("#dateOfBirth",k)||d('input[name="dateOfBirth"]',k)||d('input[data-toggle="datepicker"]',k))==null?void 0:a.value)||"";return!(!$(t)||!oe()||x('input[type="checkbox"][required]',k).filter(s=>{var c;return!((c=s.closest(".w-checkbox"))!=null&&c.querySelector(".text-color-gray-70"))}).some(s=>!s.checked))}function M(){if(!I)return;let t=ze();I.style.opacity=t?"":"0.5",I.style.pointerEvents=t?"auto":"none"}if(k){k.querySelectorAll(".w-checkbox").forEach(s=>{if(s.querySelector(".text-color-gray-70")){let c=s.querySelector('input[type="checkbox"]');c&&c.removeAttribute("required")}}),k.addEventListener("input",M),k.addEventListener("change",M),k.addEventListener("click",s=>{s.target.closest(".nice-select .option")&&setTimeout(M,50)}),M();let t=k.querySelector('#dateOfBirth, input[name="dateOfBirth"]'),o=k.querySelector("select"),a=[...k.querySelectorAll('input[type="checkbox"][required]')];if(t){t.addEventListener("blur",()=>{t.value?$(t.value)?h(t):m(t,"Format: TT.MM.JJJJ"):m(t,"Bitte Geburtsdatum eingeben")}),t.addEventListener("input",()=>{$(t.value)&&h(t),M()}),t.addEventListener("change",()=>{$(t.value)&&h(t),M()});let s=t.value;setInterval(()=>{t.value!==s&&(s=t.value,$(t.value)&&h(t),M())},300)}o&&o.addEventListener("change",()=>{o.value?h(o):m(o,"Bitte Geschlecht ausw\xE4hlen")}),k.addEventListener("click",s=>{s.target.closest(".nice-select .option")&&o&&setTimeout(()=>{oe()&&h(o)},100)}),a.forEach(s=>{s.addEventListener("change",()=>{s.checked?h(s):m(s,"Bitte akzeptieren")})})}I&&I.addEventListener("click",async t=>{var S,B,O,_;t.preventDefault(),l.log("Send button clicked (register step 2)"),J();let o=((S=d("#dateOfBirth",e))==null?void 0:S.value)||((B=d('input[name="dateOfBirth"]',e))==null?void 0:B.value)||((O=d('input[name="date-of-birth"]',e))==null?void 0:O.value)||((_=d('input[data-toggle="datepicker"]',e))==null?void 0:_.value)||"";if(!o){b(n,"Bitte Geburtsdatum eingeben");return}let a,s=o.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);s?a=`${s[3]}-${s[2].padStart(2,"0")}-${s[1].padStart(2,"0")}`:a=new Date(o).toISOString().split("T")[0];let c=oe();if(!c){b(n,"Bitte Geschlecht ausw\xE4hlen");return}if(x('input[type="checkbox"][required]',k||e).filter(v=>!v.checked).length>0){b(n,"Bitte stimme den Datenschutz- und Gesch\xE4ftsbedingungen zu");return}H.dateOfBirth=a,H.gender=c,l.log("Full registration data:",H),A(I,!0);try{await re(H),T("Registrierung erfolgreich! Bitte Code eingeben.","success"),Ne()}catch(v){l.error("Registration error:",v),b(n,v.message)}finally{A(I,!1)}});let z=d('[data-register="btn-signin"]',e);function ye(){var a,s;let t=((a=d("#email-login",e)||d('input[name="email-login"]',e))==null?void 0:a.value)||"",o=((s=d("#password-login",e)||d('input[name="password-login"]',e))==null?void 0:s.value)||"";return!!(t&&o)}function ve(){z&&(z.style.opacity=ye()?"":"0.5",z.style.pointerEvents=ye()?"auto":"none")}let we=e.querySelector('[data-register-type="sign-in"]')||e.querySelector('[data-registe-type="sign-in"]');we&&(we.addEventListener("input",ve),ve()),z&&z.addEventListener("click",async t=>{var s,c,y,C;t.preventDefault(),l.log("Signin button clicked"),J();let o=((s=d("#email-login",e))==null?void 0:s.value)||((c=d('input[name="email-login"]',e))==null?void 0:c.value)||"",a=((y=d("#password-login",e))==null?void 0:y.value)||((C=d('input[name="password-login"]',e))==null?void 0:C.value)||"";if(l.log("Login attempt:",o),!o||!a){b(n,"Bitte E-Mail und Passwort eingeben");return}A(z,!0);try{await ae(o,a),T("Anmeldung erfolgreich!","success"),ne(),U(),window.location.pathname.includes("/deine-bestellung")||fe()}catch(S){l.error("Login error:",S),b(n,S.message)}finally{A(z,!1)}});let G=x('input[name^="code-"]',e);G.forEach((t,o)=>{t.addEventListener("input",a=>{a.target.value.length===1&&o<G.length-1&&G[o+1].focus()}),t.addEventListener("keydown",a=>{a.key==="Backspace"&&!a.target.value&&o>0&&G[o-1].focus()})});let X=d('[data-register="btn-code-confirm"]',e);X&&X.addEventListener("click",async t=>{t.preventDefault(),l.log("Code confirm clicked"),J();let o="";if(G.forEach(a=>{o+=a.value}),l.log("Code entered:",o),o.length!==6){b(n,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}A(X,!0);try{await se(o),T("E-Mail erfolgreich verifiziert!","success"),ne(),U()}catch(a){l.error("Verification error:",a);let s=a.message==="Code not found"?"Der eingegebene Code ist ung\xFCltig. Bitte \xFCberpr\xFCfe den Code und versuche es erneut.":a.message,c=e.querySelector('[data-register-step]:not([style*="display: none"])')||e.querySelector('[data-register-step]:not([style*="display:none"])');if(c){let y=c.querySelector(".auth-error-message");y||(y=document.createElement("div"),y.className="auth-error-message",y.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;",c.appendChild(y)),y.textContent=s,y.style.display="block",setTimeout(()=>{y.style.display="none"},5e3)}else b(n,s)}finally{A(X,!1)}});let Ee=d('[data-register="code-resend"]',e);Ee&&Ee.addEventListener("click",async t=>{t.preventDefault(),l.log("Resend code clicked");try{await le(),T("Code wurde erneut gesendet","success")}catch(o){l.error("Resend error:",o),T(o.message,"error")}});let be=d('[data-register="password-forget"]',e);if(be){let o=function(){return t||(t=document.createElement("div"),t.className="forgot-password-container",t.style.cssText="padding: 0;",t.innerHTML=`
          <div data-forgot-step="email" style="display:block;">
            <div class="form_field-wrap" style="margin-bottom:16px;">
              <div class="form_field">
                <input type="email" class="form_input w-input" placeholder=" " data-forgot="email" required>
                <label class="form_label">E-Mail-Adresse</label>
              </div>
            </div>
            <a href="#" class="btn_primary w-button" data-forgot="send-code" style="width:100%;text-align:center;display:block;">Code senden</a>
            <div style="text-align:center;margin-top:12px;">
              <a href="#" data-forgot="back-to-login" style="font-size:13px;color:#245BEC;text-decoration:none;">Zur\xFCck zum Login</a>
            </div>
          </div>
          <div data-forgot-step="reset" style="display:none;">
            <div class="form_field-wrap" style="margin-bottom:16px;">
              <div class="form_field">
                <input type="text" class="form_input w-input" placeholder=" " data-forgot="code" maxlength="6" inputmode="numeric" required>
                <label class="form_label">6-stelliger Code</label>
              </div>
            </div>
            <div class="form_field-wrap" style="margin-bottom:16px;">
              <div class="form_field">
                <input type="password" class="form_input w-input" placeholder=" " data-forgot="new-password" required>
                <label class="form_label">Neues Passwort</label>
              </div>
            </div>
            <a href="#" class="btn_primary w-button" data-forgot="confirm-reset" style="width:100%;text-align:center;display:block;">Passwort zur\xFCcksetzen</a>
            <div style="text-align:center;margin-top:12px;">
              <a href="#" data-forgot="back-to-email" style="font-size:13px;color:#245BEC;text-decoration:none;">Zur\xFCck</a>
            </div>
          </div>
        `,t)},a=function(c){var C;D().forEach(S=>S.style.display="none"),t.parentNode||(C=e.querySelector("form"))!=null&&C.appendChild(t)||e.appendChild(t),t.style.display="block",t.querySelectorAll("[data-forgot-step]").forEach(S=>{S.style.display=S.getAttribute("data-forgot-step")===c?"block":"none"})},s=function(){t&&(t.style.display="none")};var De=o,Ue=a,Ke=s;let t=null;be.addEventListener("click",c=>{c.preventDefault(),l.log("Password forget clicked"),o(),a("email")}),e.addEventListener("click",async c=>{var C,S,B,O;let y=c.target;if(y.matches('[data-forgot="back-to-login"]')){c.preventDefault(),s(),Y();return}if(y.matches('[data-forgot="back-to-email"]')){c.preventDefault(),a("email");return}if(y.matches('[data-forgot="send-code"]')){c.preventDefault();let _=t.querySelector('[data-forgot="email"]'),v=(C=_==null?void 0:_.value)==null?void 0:C.trim();if(!v||!v.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){b(e.querySelector("form")||e,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}A(y,!0);try{let L=await q("/user/forgot-password",{method:"POST",body:JSON.stringify({email:v})});if(!L.ok){let P=await L.json().catch(()=>({}));throw new Error(P.message||"Fehler beim Senden des Codes")}T("Code wurde an deine E-Mail gesendet","success"),t._email=v,a("reset")}catch(L){l.error("Forgot password error:",L),b(e.querySelector("form")||e,L.message)}finally{A(y,!1)}return}if(y.matches('[data-forgot="confirm-reset"]')){c.preventDefault();let _=(B=(S=t.querySelector('[data-forgot="code"]'))==null?void 0:S.value)==null?void 0:B.trim(),v=(O=t.querySelector('[data-forgot="new-password"]'))==null?void 0:O.value;if(!_||_.length!==6){b(e.querySelector("form")||e,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}if(!v||v.length<8||!/[A-Z]/.test(v)||!/[a-z]/.test(v)||!/[0-9]/.test(v)||!/[^A-Za-z0-9]/.test(v)){b(e.querySelector("form")||e,"Mindestens 8 Zeichen, Gro\xDF-/Kleinbuchstabe, Zahl und Sonderzeichen");return}A(y,!0);try{let L=await q("/user/forgot-password-verification",{method:"POST",body:JSON.stringify({code:_,newPassword:v})});if(!L.ok){let P=await L.json().catch(()=>({}));throw new Error(P.message||"Fehler beim Zur\xFCcksetzen des Passworts")}T("Passwort erfolgreich zur\xFCckgesetzt!","success"),s(),Y()}catch(L){l.error("Password reset error:",L),b(e.querySelector("form")||e,L.message)}finally{A(y,!1)}return}})}let ke=d('[data-register="google-signin"]',e);ke&&ke.addEventListener("click",t=>{t.preventDefault(),l.log("Google signin clicked"),window.location.href=Z.API_BASE+"/auth/google"});let Se=d('[data-register="apple-signin"]',e);Se&&Se.addEventListener("click",t=>{t.preventDefault(),l.log("Apple signin clicked"),window.location.href=Z.API_BASE+"/auth/apple"}),l.log("Auth handlers setup complete")}function U(){var g,f;let e=ee(),n=j();l.log("Updating auth UI, authenticated:",e,n),x('[data-auth-show="logged-in"]').forEach(p=>{p.style.display=e?"":"none"});let i=window.location.pathname,r=i==="/"||i==="/en"||i==="/en/"||i.includes("/vision");x('[data-auth-show="logged-out"]').forEach(p=>{p.classList.contains("nav_user")?r?p.style.display="none":p.style.display="":p.style.display=e?"none":""}),n&&(x('[data-auth-user="name"]').forEach(p=>{p.textContent=n.name}),x('[data-auth-user="email"]').forEach(p=>{p.textContent=n.email}));let u=d(".nav_user");if(u)if(e&&n){let p=(n.name||"").trim().split(/\s+/),m=((((g=p[0])==null?void 0:g[0])||"")+(((f=p[p.length-1])==null?void 0:f[0])||"")).toUpperCase();u._originalHTML||(u._originalHTML=u.innerHTML),u.innerHTML='<div style="width:35px;height:35px;border-radius:50%;background:rgba(36,91,236,0.15);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:400;color:#000;font-family:inherit;line-height:1;">'+m+"</div>"}else u._originalHTML&&(u.innerHTML=u._originalHTML)}let Te="https://calendly.com/bluesphere-biomarker/bluttest";function fe(){l.log("Opening Calendly modal");let e=j(),n=(e==null?void 0:e.name)||localStorage.getItem("userName")||"",i=(e==null?void 0:e.email)||localStorage.getItem("userEmail")||"",r=document.getElementById("calendly-modal-overlay");if(r){let p=document.getElementById("calendly-embed-container");p&&(p.innerHTML=""),r.style.display="flex",setTimeout(()=>{r.style.opacity="1"},10),pe(n,i);return}r=document.createElement("div"),r.id="calendly-modal-overlay",r.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;";let u=document.createElement("div");u.style.cssText="background:#fff;border-radius:12px;width:90vw;max-width:700px;height:85vh;max-height:750px;position:relative;overflow:hidden;";let g=document.createElement("button");g.textContent="\u2715",g.style.cssText="position:absolute;top:12px;right:16px;z-index:10;background:none;border:none;font-size:20px;cursor:pointer;color:#333;",g.addEventListener("click",W);let f=document.createElement("div");f.id="calendly-embed-container",f.style.cssText="width:100%;height:100%;",u.appendChild(g),u.appendChild(f),r.appendChild(u),document.body.appendChild(r),r.addEventListener("click",p=>{p.target===r&&W()}),setTimeout(()=>{r.style.opacity="1"},10),pe(n,i),Be()}function pe(e,n){let i=document.getElementById("calendly-embed-container");if(!i)return;let r=Te+"?hide_gdpr_banner=1";e&&(r+="&name="+encodeURIComponent(e)),n&&(r+="&email="+encodeURIComponent(n));let u=document.createElement("div");if(u.className="calendly-inline-widget",u.setAttribute("data-url",r),u.style.cssText="min-width:100%;height:100%;",i.appendChild(u),document.querySelector('script[src*="assets.calendly.com"]'))window.Calendly&&window.Calendly.initInlineWidget({url:r,parentElement:i});else{let g=document.createElement("script");g.src="https://assets.calendly.com/assets/external/widget.js",g.async=!0,document.body.appendChild(g)}l.log("Calendly widget injected with name:",e,"email:",n)}function Be(){window.addEventListener("message",e=>{var n,i,r,u,g;if(e.origin==="https://calendly.com"&&((n=e.data)==null?void 0:n.event)==="calendly.event_scheduled"){l.log("Calendly event scheduled:",e.data);let f=j(),p={userId:(f==null?void 0:f.id)||localStorage.getItem("userId"),userName:(f==null?void 0:f.name)||localStorage.getItem("userName"),userEmail:(f==null?void 0:f.email)||localStorage.getItem("userEmail"),eventUri:(r=(i=e.data.payload)==null?void 0:i.event)==null?void 0:r.uri,inviteeUri:(g=(u=e.data.payload)==null?void 0:u.invitee)==null?void 0:g.uri,scheduledAt:new Date().toISOString()};l.log("Booking data:",p),localStorage.setItem("lastBooking",JSON.stringify(p)),setTimeout(()=>{W(),T("Termin erfolgreich gebucht!","success")},1500)}})}function W(){let e=document.getElementById("calendly-modal-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300),l.log("Calendly modal closed"))}function Q(){let e=document.getElementById("nav-user-dropdown");e&&e.remove()}function Oe(e){Q();let n=j();if(!n)return;let i=document.createElement("div");i.id="nav-user-dropdown",i.style.cssText="position:absolute;top:100%;right:0;margin-top:8px;background:#fff;color:#000;border-radius:10px;padding:16px 20px;min-width:220px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.12);font-family:inherit;";let r=document.createElement("div");r.textContent=n.name||"",r.style.cssText="font-size:15px;font-weight:600;margin-bottom:4px;color:#000;";let u=document.createElement("div");u.textContent=n.email||"",u.style.cssText="font-size:13px;color:#4B4B4E;margin-bottom:14px;";let g=document.createElement("button");g.setAttribute("data-auth-logout",""),g.style.cssText="display:flex;align-items:center;gap:8px;width:100%;padding:8px 0;background:none;border:none;color:#000;font-size:14px;cursor:pointer;transition:opacity 0.2s;font-family:inherit;",g.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Logout',g.addEventListener("mouseenter",()=>{g.style.opacity="0.6"}),g.addEventListener("mouseleave",()=>{g.style.opacity="1"}),i.appendChild(r),i.appendChild(u),i.appendChild(g);let f=e.closest(".nav_user")||e;f.style.position="relative",f.appendChild(i)}function qe(){let e=window.location.pathname;e==="/"||e==="/en"||e==="/en/"||e.includes("/vision")||document.addEventListener("click",i=>{let r=i.target.closest(".nav_user");if(!r){Q();return}i.preventDefault(),ee()?document.getElementById("nav-user-dropdown")?Q():Oe(r):V()})}function Re(){document.addEventListener("click",e=>{e.target.closest("[data-auth-logout]")&&(e.preventDefault(),Q(),de(),U(),T("Erfolgreich abgemeldet","info"),l.log("User logged out via button"))})}function Ie(){let e=new URLSearchParams(window.location.search),n=e.get("token")||e.get("accessToken"),i=e.get("refreshToken");if(!n)return!1;l.log("OAuth callback detected, storing tokens"),E.set(w.TOKEN_KEY,n),i&&E.set(w.REFRESH_KEY,i,60*24*7);let r=e.get("name")||e.get("firstName")||"",u=e.get("email")||"";(r||u)&&E.set(w.USER_KEY,{name:r,email:u});let g=new URL(window.location);return["token","accessToken","refreshToken","name","firstName","lastName","email"].forEach(f=>g.searchParams.delete(f)),window.history.replaceState({},"",g.pathname+g.search),!r&&!u&&q("/user/profile").then(async f=>{if(f.ok){let p=await f.json(),m=p.result||p;E.set(w.USER_KEY,{name:m.firstName?`${m.firstName} ${m.lastName}`:m.name||"",email:m.email||"",id:m.id}),U()}}).catch(()=>{}),!0}function me(){l.log("Initializing global auth module"),Ie(),Ae(),Re(),qe(),U(),window.Auth={isAuthenticated:ee,getCurrentUser:j,login:ae,register:re,verifyEmail:se,resendCode:le,logout:de,openModal:V,openRegister:()=>V("register"),openLogin:()=>V("login"),closeModal:ne,openCalendly:fe,closeCalendly:W,updateUI:U},l.log("Global auth module ready. Use Auth.openModal() to open.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",me):me()})();})();
