"use strict";(()=>{(function(){let x={API_BASE:"https://bluesphere.dev.longtermhealth.de",DEBUG:!0},d={TOKEN_KEY:"auth_token",REFRESH_KEY:"refresh_token",USER_KEY:"user_data"},r={log:(...e)=>x.DEBUG&&console.log("[AUTH]",...e),error:(...e)=>console.error("[AUTH]",...e)},o=(e,t=document)=>t.querySelector(e),f=(e,t=document)=>[...t.querySelectorAll(e)],u={set:function(e,t,n=60){let a={value:t,expiry:new Date().getTime()+n*60*1e3};try{sessionStorage.setItem(e,JSON.stringify(a))}catch(c){r.error("Storage error:",c)}},get:function(e){try{let t=sessionStorage.getItem(e);if(!t)return null;let n=JSON.parse(t);return new Date().getTime()>n.expiry?(sessionStorage.removeItem(e),null):n.value}catch{return null}},remove:function(e){sessionStorage.removeItem(e)}};async function T(e,t={}){let n=x.API_BASE+e,a=u.get(d.TOKEN_KEY),c={"Content-Type":"application/json",...t.headers};a&&(c.Authorization=`Bearer ${a}`),r.log("API Call:",e,t.method||"GET");try{let p=await fetch(n,{...t,headers:c});return r.log("API Response:",p.status),p}catch(p){throw r.error("API error:",p),p}}let M={firstName:"",lastName:"",email:"",password:""};async function U(e){let{firstName:t,lastName:n,email:a,password:c,dateOfBirth:p,gender:h}=e;r.log("Registering user:",a);let b={firstName:t.trim(),lastName:n.trim(),email:a.toLowerCase().trim(),password:c,dateOfBirth:p,gender:h,role:"PATIENT"},w=await T("/user/registration",{method:"POST",body:JSON.stringify(b)});if(!w.ok){let S=await w.json().catch(()=>({}));throw new Error(S.statusMessage||S.message||"Registrierung fehlgeschlagen")}let E=await w.json();return r.log("Registration successful:",E),u.set(d.USER_KEY,{name:`${t} ${n}`,email:a,id:E.userId||E.id}),E}async function D(e,t){var p;r.log("Logging in user:",e);let n=await T("/user/login",{method:"POST",body:JSON.stringify({email:e.toLowerCase().trim(),password:t})});if(!n.ok){let h=await n.json().catch(()=>({}));throw new Error(h.statusMessage||h.message||"Anmeldung fehlgeschlagen")}let a=await n.json();r.log("Login response:",a);let c=((p=a.result)==null?void 0:p.user)||a.user||a;return(a.token||a.accessToken)&&u.set(d.TOKEN_KEY,a.token||a.accessToken),a.refreshToken&&u.set(d.REFRESH_KEY,a.refreshToken,60*24*7),u.set(d.USER_KEY,{name:c.firstName?`${c.firstName} ${c.lastName}`:c.name,email:c.email,id:c.id}),r.log("Login successful"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),c}async function I(e){r.log("Verifying email with code:",e);let t=await T("/user/confirmation",{method:"POST",body:JSON.stringify({code:e.trim()})});if(!t.ok&&t.status!==201){let a=await t.json().catch(()=>({}));throw new Error(a.statusMessage||a.message||"Verifizierung fehlgeschlagen")}let n=await t.json();return r.log("Verification successful:",n),(n.token||n.accessToken)&&u.set(d.TOKEN_KEY,n.token||n.accessToken),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),n}async function P(){r.log("Resending verification code");let e=u.get(d.USER_KEY);if(!(e!=null&&e.email))throw new Error("Keine E-Mail-Adresse gefunden");let t=await T("/user/verification-code-resend",{method:"POST",body:JSON.stringify({email:e.email})});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.statusMessage||n.message||"Code konnte nicht gesendet werden")}return!0}function Y(){let e=u.get(d.TOKEN_KEY),t=u.get(d.USER_KEY);return!!(e&&t)}function G(){return u.get(d.USER_KEY)}function me(){u.remove(d.TOKEN_KEY),u.remove(d.REFRESH_KEY),u.remove(d.USER_KEY),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!1}})),r.log("User logged out")}let pe=0,F="login";function z(){return o('[data-modal-name="register"]')}function N(){let e=z();return e?f('[data-register="form-step"]',e):f('[data-register="form-step"]')}function L(e){N().forEach((n,a)=>{n.style.display=a===e?"block":"none"}),pe=e,r.log("Showing step:",e)}function he(){let e=N();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="register"){L(t),F="register";return}}function $(){let e=N();for(let t=0;t<e.length;t++)if((e[t].getAttribute("data-registe-type")||e[t].getAttribute("data-register-type"))==="sign-in"){L(t),F="login";return}}function we(){let e=N();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="code"){L(t);return}}function _(){L(0)}function Ee(){if(r.log("Opening register modal"),typeof window.openModal=="function")window.openModal("register"),setTimeout(()=>{_()},100);else{let e=o('[data-modal-target="register"]'),t=o('[data-modal-name="register"]'),n=o("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","active"),t&&t.setAttribute("data-modal-status","active"),n&&n.setAttribute("data-modal-group-status","active"),setTimeout(()=>{_()},100)}}function O(){if(typeof window.closeAllModals=="function")window.closeAllModals();else{let e=o('[data-modal-target="register"]'),t=o('[data-modal-name="register"]'),n=o("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","not-active"),t&&t.setAttribute("data-modal-status","not-active"),n&&n.setAttribute("data-modal-group-status","not-active")}}function m(e,t){let n=e.querySelector(".auth-error-message");if(!n){n=document.createElement("div"),n.className="auth-error-message",n.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;";let a=e.querySelector(".form_field-wrap");a?a.parentNode.insertBefore(n,a):e.prepend(n)}n.textContent=t,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)}function K(){f(".auth-error-message").forEach(e=>e.style.display="none")}function k(e,t){t?(e.setAttribute("data-loading","true"),e.style.opacity="0.7",e.style.pointerEvents="none"):(e.removeAttribute("data-loading"),e.style.opacity="1",e.style.pointerEvents="auto")}function v(e,t="info"){let n=document.createElement("div");n.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}function ve(){r.log("Setting up auth handlers");let e=z();if(!e){r.log("Register modal not found");return}let t=o('[data-register="form-wrap"]',e);if(!t){r.log("Auth form not found in register modal");return}r.log("Found form in register modal"),t.addEventListener("submit",s=>{s.preventDefault()});let n=o('[data-register="email-signin"]',e);n&&n.addEventListener("click",s=>{s.preventDefault(),r.log("Email signin clicked"),$()}),f('[data-register="register-link"]',e).forEach(s=>{s.addEventListener("click",i=>{i.preventDefault(),r.log("Register link clicked"),he()})}),f('[data-register="login-link"]',e).forEach(s=>{s.addEventListener("click",i=>{i.preventDefault(),r.log("Login link clicked"),$()})}),f('[data-register="btn-back"]',e).forEach(s=>{s.addEventListener("click",i=>{i.preventDefault(),r.log("Back button clicked"),_()})});let h=o('[data-register="btn-next"]',e);h&&h.addEventListener("click",async s=>{var Z,Q,W,X,ee,te,ne,re,oe,ae,se,ie,le,ce,de,ue,ge;s.preventDefault(),r.log("Next button clicked (register)"),K();let i=((Z=o("#first_name",e))==null?void 0:Z.value)||((Q=o('input[name="first_name"]',e))==null?void 0:Q.value)||"",l=((W=o("#last_name",e))==null?void 0:W.value)||((X=o('input[name="last_name"]',e))==null?void 0:X.value)||"",y=((ee=o("#email-sign-in",e))==null?void 0:ee.value)||((te=o('input[name="email-sign-in"]',e))==null?void 0:te.value)||"",g=((ne=o("#password-signin",e))==null?void 0:ne.value)||((re=o('input[name="password-signin"]',e))==null?void 0:re.value)||"",R=((oe=o("#password-signin-again",e))==null?void 0:oe.value)||((ae=o('input[name="password-signin-again"]',e))==null?void 0:ae.value)||"";if(r.log("Form values:",{firstName:i,lastName:l,email:y,hasPassword:!!g}),!i||!l){m(t,"Bitte Vor- und Nachnamen eingeben");return}if(!y||!y.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){m(t,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}if(!g||g.length<8||!/[A-Z]/.test(g)||!/[a-z]/.test(g)||!/[0-9]/.test(g)||!/[^A-Za-z0-9]/.test(g)){m(t,"Passwort: min. 8 Zeichen, 1 Gro\xDFbuchstabe, 1 Kleinbuchstabe, 1 Zahl und 1 Sonderzeichen");return}if(g!==R){m(t,"Passw\xF6rter stimmen nicht \xFCberein");return}let A=((se=o("#date-of-birth",e))==null?void 0:se.value)||((ie=o('input[name="date-of-birth"]',e))==null?void 0:ie.value)||((le=o('input[name="dateOfBirth"]',e))==null?void 0:le.value)||((ce=o('input[type="date"]',e))==null?void 0:ce.value)||"";if(!A){m(t,"Bitte Geburtsdatum eingeben");return}let C=new Date(A).toISOString().split("T")[0],q=((de=o("#gender-register",e))==null?void 0:de.value)||((ue=o('select[name="gender-register"]',e))==null?void 0:ue.value)||((ge=o('select[name="gender"]',e))==null?void 0:ge.value)||"";if(!q){m(t,"Bitte Geschlecht ausw\xE4hlen");return}M={firstName:i,lastName:l,email:y,password:g,dateOfBirth:C,gender:q},k(h,!0);try{await U(M),v("Registrierung erfolgreich! Bitte Code eingeben.","success"),we()}catch(fe){r.error("Registration error:",fe),m(t,fe.message)}finally{k(h,!1)}});let b=o('[data-register="btn-signin"]',e);b&&b.addEventListener("click",async s=>{var y,g,R,A;s.preventDefault(),r.log("Signin button clicked"),K();let i=((y=o("#email-login",e))==null?void 0:y.value)||((g=o('input[name="email-login"]',e))==null?void 0:g.value)||"",l=((R=o("#password-login",e))==null?void 0:R.value)||((A=o('input[name="password-login"]',e))==null?void 0:A.value)||"";if(r.log("Login attempt:",i),!i||!l){m(t,"Bitte E-Mail und Passwort eingeben");return}k(b,!0);try{await D(i,l),v("Anmeldung erfolgreich!","success"),O(),B()}catch(C){r.error("Login error:",C),m(t,C.message)}finally{k(b,!1)}});let w=f('input[name^="code-"]',e);w.forEach((s,i)=>{s.addEventListener("input",l=>{l.target.value.length===1&&i<w.length-1&&w[i+1].focus()}),s.addEventListener("keydown",l=>{l.key==="Backspace"&&!l.target.value&&i>0&&w[i-1].focus()})});let E=o('[data-register="btn-code-confirm"]',e);E&&E.addEventListener("click",async s=>{s.preventDefault(),r.log("Code confirm clicked"),K();let i="";if(w.forEach(l=>{i+=l.value}),r.log("Code entered:",i),i.length!==6){m(t,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}k(E,!0);try{await I(i),v("E-Mail erfolgreich verifiziert!","success"),O(),B()}catch(l){r.error("Verification error:",l),m(t,l.message)}finally{k(E,!1)}});let S=o('[data-register="code-resend"]',e);S&&S.addEventListener("click",async s=>{s.preventDefault(),r.log("Resend code clicked");try{await P(),v("Code wurde erneut gesendet","success")}catch(i){r.error("Resend error:",i),v(i.message,"error")}});let H=o('[data-register="password-forget"]',e);H&&H.addEventListener("click",s=>{s.preventDefault(),r.log("Password forget clicked"),v("Passwort-Reset wird noch implementiert","info")});let J=o('[data-register="google-signin"]',e);J&&J.addEventListener("click",s=>{s.preventDefault(),r.log("Google signin clicked"),v("Google-Anmeldung wird noch implementiert","info")});let V=o('[data-register="apple-signin"]',e);V&&V.addEventListener("click",s=>{s.preventDefault(),r.log("Apple signin clicked"),v("Apple-Anmeldung wird noch implementiert","info")}),r.log("Auth handlers setup complete")}function B(){let e=Y(),t=G();r.log("Updating auth UI, authenticated:",e,t),f('[data-auth-show="logged-in"]').forEach(n=>{n.style.display=e?"":"none"}),f('[data-auth-show="logged-out"]').forEach(n=>{n.style.display=e?"none":""}),t&&(f('[data-auth-user="name"]').forEach(n=>{n.textContent=t.name}),f('[data-auth-user="email"]').forEach(n=>{n.textContent=t.email}))}function j(){r.log("Initializing global auth module"),ve(),B(),window.Auth={isAuthenticated:Y,getCurrentUser:G,login:D,register:U,verifyEmail:I,resendCode:P,logout:me,openModal:Ee,closeModal:O,updateUI:B},r.log("Global auth module ready. Use Auth.openModal() to open.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",j):j()})();})();
