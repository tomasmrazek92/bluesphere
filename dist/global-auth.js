"use strict";(()=>{(function(){let J={API_BASE:"https://bluesphere.dev.longtermhealth.de",DEBUG:!0},f={TOKEN_KEY:"auth_token",REFRESH_KEY:"refresh_token",USER_KEY:"user_data"},s={log:(...e)=>J.DEBUG&&console.log("[AUTH]",...e),error:(...e)=>console.error("[AUTH]",...e)},i=(e,t=document)=>t.querySelector(e),h=(e,t=document)=>[...t.querySelectorAll(e)],y={set:function(e,t,n=60){let a={value:t,expiry:new Date().getTime()+n*60*1e3};try{sessionStorage.setItem(e,JSON.stringify(a))}catch(r){s.error("Storage error:",r)}},get:function(e){try{let t=sessionStorage.getItem(e);if(!t)return null;let n=JSON.parse(t);return new Date().getTime()>n.expiry?(sessionStorage.removeItem(e),null):n.value}catch{return null}},remove:function(e){sessionStorage.removeItem(e)}};async function Y(e,t={}){let n=J.API_BASE+e,a=y.get(f.TOKEN_KEY),r={"Content-Type":"application/json",...t.headers};a&&(r.Authorization=`Bearer ${a}`),s.log("API Call:",e,t.method||"GET");try{let d=await fetch(n,{...t,headers:r});return s.log("API Response:",d.status),d}catch(d){throw s.error("API error:",d),d}}let B={firstName:"",lastName:"",email:"",password:""},W={male:"MALE",female:"FEMALE",diverse:"NON_BINARY","non-binary":"NON_BINARY",other:"OTHER","no-share":"NO_SHARE",unknown:"UNKNOWN",MALE:"MALE",FEMALE:"FEMALE",NON_BINARY:"NON_BINARY",OTHER:"OTHER",NO_SHARE:"NO_SHARE",UNKNOWN:"UNKNOWN"};async function Z(e){let{firstName:t,lastName:n,email:a,password:r,dateOfBirth:d,gender:u}=e;s.log("Registering user:",a);let p=W[u]||W[u.toLowerCase()]||"UNKNOWN",S={firstName:t.trim(),lastName:n.trim(),email:a.toLowerCase().trim(),password:r,dateOfBirth:d,gender:p,role:"PATIENT"},k=await Y("/user/registration",{method:"POST",body:JSON.stringify(S)});if(!k.ok){let b=await k.json().catch(()=>({}));throw new Error(b.statusMessage||b.message||"Registrierung fehlgeschlagen")}let N=await k.json();return s.log("Registration successful:",N),y.set(f.USER_KEY,{name:`${t} ${n}`,email:a,id:N.userId||N.id}),N}async function Q(e,t){s.log("Logging in user:",e);let n=await Y("/user/login",{method:"POST",body:JSON.stringify({email:e.toLowerCase().trim(),password:t})});if(!n.ok){let k=await n.json().catch(()=>({}));throw new Error(k.statusMessage||k.message||"Anmeldung fehlgeschlagen")}let a=await n.json();s.log("Login response:",a);let r=a.result||a,d=r.user||r,u=r.token||r.accessToken||a.token||a.accessToken,p=r.refreshToken||a.refreshToken;u?(y.set(f.TOKEN_KEY,u),s.log("Token stored")):s.log("Warning: No token in login response"),p&&y.set(f.REFRESH_KEY,p,60*24*7);let S={name:d.firstName?`${d.firstName} ${d.lastName}`:d.name,email:d.email||e,id:d.id};return y.set(f.USER_KEY,S),localStorage.setItem("userName",S.name),localStorage.setItem("userEmail",S.email),localStorage.setItem("userId",String(S.id)),s.log("Login successful"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),d}async function X(e){s.log("Verifying email with code:",e);let t=await Y("/user/confirmation",{method:"POST",body:JSON.stringify({code:e.trim()})});if(!t.ok&&t.status!==201){let a=await t.json().catch(()=>({}));throw new Error(a.statusMessage||a.message||"Verifizierung fehlgeschlagen")}let n=await t.json();return s.log("Verification successful:",n),(n.token||n.accessToken)&&y.set(f.TOKEN_KEY,n.token||n.accessToken),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),n}async function ee(){s.log("Resending verification code");let e=y.get(f.USER_KEY);if(!(e!=null&&e.email))throw new Error("Keine E-Mail-Adresse gefunden");let t=await Y("/user/verification-code-resend",{method:"POST",body:JSON.stringify({email:e.email})});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.statusMessage||n.message||"Code konnte nicht gesendet werden")}return!0}function $(){let e=y.get(f.TOKEN_KEY),t=y.get(f.USER_KEY);return!!(e||t)}function I(){return y.get(f.USER_KEY)}function te(){y.remove(f.TOKEN_KEY),y.remove(f.REFRESH_KEY),y.remove(f.USER_KEY),localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userId"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!1}})),s.log("User logged out")}let ke=0,ne="login";function oe(){return i('[data-modal-name="register"]')}function O(){let e=oe();return e?h('[data-register="form-step"]',e):h('[data-register="form-step"]')}function _(e){O().forEach((n,a)=>{n.style.display=a===e?"block":"none"}),ke=e,s.log("Showing step:",e)}function ae(){let e=O();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="register"){_(t),ne="register";return}}function ie(){let e=O();for(let t=0;t<e.length;t++)if((e[t].getAttribute("data-registe-type")||e[t].getAttribute("data-register-type"))==="sign-in"){_(t),ne="login";return}}function Se(){let e=O();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="personal-info"){_(t);return}}function xe(){let e=O();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="code"){_(t);return}}function j(){_(0)}function se(){if(s.log("Opening register modal"),typeof window.openModal=="function")window.openModal("register"),setTimeout(()=>{j()},100);else{let e=i('[data-modal-target="register"]'),t=i('[data-modal-name="register"]'),n=i("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","active"),t&&t.setAttribute("data-modal-status","active"),n&&n.setAttribute("data-modal-group-status","active"),setTimeout(()=>{j()},100)}}function V(){if(typeof window.closeAllModals=="function")window.closeAllModals();else{let e=i('[data-modal-target="register"]'),t=i('[data-modal-name="register"]'),n=i("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","not-active"),t&&t.setAttribute("data-modal-status","not-active"),n&&n.setAttribute("data-modal-group-status","not-active")}}function v(e,t){let n=e.querySelector(".auth-error-message");if(!n){n=document.createElement("div"),n.className="auth-error-message",n.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;";let a=e.querySelector(".form_field-wrap");a?a.parentNode.insertBefore(n,a):e.prepend(n)}n.textContent=t,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)}function H(){h(".auth-error-message").forEach(e=>e.style.display="none")}function C(e,t){t?(e.setAttribute("data-loading","true"),e.style.opacity="0.7",e.style.pointerEvents="none"):(e.removeAttribute("data-loading"),e.style.opacity="1",e.style.pointerEvents="auto")}function E(e,t="info"){let n=document.createElement("div");n.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}function Ne(){s.log("Setting up auth handlers");let e=oe();if(!e){s.log("Register modal not found");return}let t=i('[data-register="form-wrap"]',e);if(!t){s.log("Auth form not found in register modal");return}s.log("Found form in register modal"),t.addEventListener("submit",o=>{o.preventDefault()});let n=i('[data-register="email-signin"]',e);n&&n.addEventListener("click",o=>{o.preventDefault(),s.log("Email signin clicked"),ie()}),h('[data-register="register-link"]',e).forEach(o=>{o.addEventListener("click",l=>{l.preventDefault(),s.log("Register link clicked"),ae()})}),h('[data-register="login-link"]',e).forEach(o=>{o.addEventListener("click",l=>{l.preventDefault(),s.log("Login link clicked"),ie()})}),h('[data-register="btn-back"]',e).forEach(o=>{o.addEventListener("click",l=>{l.preventDefault(),s.log("Back button clicked");let c=o.closest('[data-register="form-step"]');c&&c.getAttribute("data-register-type")==="personal-info"?ae():j()})});let u=i('[data-register="btn-next"]',e);function p(){var o,l,c,g,m;return{firstName:((o=i("#first_name",e)||i('input[name="first_name"]',e))==null?void 0:o.value)||"",lastName:((l=i("#last_name",e)||i('input[name="last_name"]',e))==null?void 0:l.value)||"",email:((c=i("#email-sign-in",e)||i('input[name="email-sign-in"]',e))==null?void 0:c.value)||"",password:((g=i("#password-signin",e)||i('input[name="password-signin"]',e))==null?void 0:g.value)||"",passwordConfirm:((m=i("#password-signin-again",e)||i('input[name="password-signin-again"]',e))==null?void 0:m.value)||""}}function S(){let o=p();return!(!o.firstName||!o.lastName||!o.email||!o.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)||!o.password||o.password.length<8||!/[A-Z]/.test(o.password)||!/[a-z]/.test(o.password)||!/[0-9]/.test(o.password)||!/[^A-Za-z0-9]/.test(o.password)||o.password!==o.passwordConfirm)}function k(){if(!u)return;let o=S();u.style.opacity=o?"":"0.5",u.style.pointerEvents=o?"auto":"none"}let N=e.querySelector('[data-register-type="register"]');N&&(N.addEventListener("input",k),k()),u&&u.addEventListener("click",o=>{var T,x,D,K,z,L,ve,we,Ee,be;o.preventDefault(),s.log("Next button clicked (register step 1)"),H();let l=((T=i("#first_name",e))==null?void 0:T.value)||((x=i('input[name="first_name"]',e))==null?void 0:x.value)||"",c=((D=i("#last_name",e))==null?void 0:D.value)||((K=i('input[name="last_name"]',e))==null?void 0:K.value)||"",g=((z=i("#email-sign-in",e))==null?void 0:z.value)||((L=i('input[name="email-sign-in"]',e))==null?void 0:L.value)||"",m=((ve=i("#password-signin",e))==null?void 0:ve.value)||((we=i('input[name="password-signin"]',e))==null?void 0:we.value)||"",M=((Ee=i("#password-signin-again",e))==null?void 0:Ee.value)||((be=i('input[name="password-signin-again"]',e))==null?void 0:be.value)||"";if(s.log("Form values:",{firstName:l,lastName:c,email:g,hasPassword:!!m}),!l||!c){v(t,"Bitte Vor- und Nachnamen eingeben");return}if(!g||!g.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){v(t,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}if(!m||m.length<8||!/[A-Z]/.test(m)||!/[a-z]/.test(m)||!/[0-9]/.test(m)||!/[^A-Za-z0-9]/.test(m)){v(t,"Passwort: min. 8 Zeichen, 1 Gro\xDFbuchstabe, 1 Kleinbuchstabe, 1 Zahl und 1 Sonderzeichen");return}if(m!==M){v(t,"Passw\xF6rter stimmen nicht \xFCberein");return}B={firstName:l,lastName:c,email:g,password:m},Se()});let b=i('[data-register="btn-send"]',e),w=e.querySelector('[data-register-type="personal-info"]');function ce(){if(!w)return"";let o=i("select",w),l=(o==null?void 0:o.value)||"";if(!l&&o){let c=o.nextElementSibling;if(c&&c.classList.contains("nice-select")){let g=c.querySelector(".option.selected");g&&g.getAttribute("data-value")&&(l=g.getAttribute("data-value"))}}return l}function Ie(){var c;return!(!w||!(((c=i("#dateOfBirth",w)||i('input[name="dateOfBirth"]',w)||i('input[data-toggle="datepicker"]',w))==null?void 0:c.value)||"")||!ce()||h('input[type="checkbox"][required]',w).some(g=>!g.checked))}function q(){if(!b)return;let o=Ie();b.style.opacity=o?"":"0.5",b.style.pointerEvents=o?"auto":"none"}w&&(w.addEventListener("input",q),w.addEventListener("change",q),w.addEventListener("click",o=>{o.target.closest(".nice-select .option")&&setTimeout(q,50)}),q()),b&&b.addEventListener("click",async o=>{var x,D,K,z;o.preventDefault(),s.log("Send button clicked (register step 2)"),H();let l=((x=i("#dateOfBirth",e))==null?void 0:x.value)||((D=i('input[name="dateOfBirth"]',e))==null?void 0:D.value)||((K=i('input[name="date-of-birth"]',e))==null?void 0:K.value)||((z=i('input[data-toggle="datepicker"]',e))==null?void 0:z.value)||"";if(!l){v(t,"Bitte Geburtsdatum eingeben");return}let c,g=l.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);g?c=`${g[3]}-${g[2].padStart(2,"0")}-${g[1].padStart(2,"0")}`:c=new Date(l).toISOString().split("T")[0];let m=ce();if(!m){v(t,"Bitte Geschlecht ausw\xE4hlen");return}if(h('input[type="checkbox"][required]',w||e).filter(L=>!L.checked).length>0){v(t,"Bitte stimme den Datenschutz- und Gesch\xE4ftsbedingungen zu");return}B.dateOfBirth=c,B.gender=m,s.log("Full registration data:",B),C(b,!0);try{await Z(B),E("Registrierung erfolgreich! Bitte Code eingeben.","success"),xe()}catch(L){s.error("Registration error:",L),v(t,L.message)}finally{C(b,!1)}});let A=i('[data-register="btn-signin"]',e);function ue(){var c,g;let o=((c=i("#email-login",e)||i('input[name="email-login"]',e))==null?void 0:c.value)||"",l=((g=i("#password-login",e)||i('input[name="password-login"]',e))==null?void 0:g.value)||"";return!!(o&&l)}function ge(){A&&(A.style.opacity=ue()?"":"0.5",A.style.pointerEvents=ue()?"auto":"none")}let me=e.querySelector('[data-register-type="sign-in"]')||e.querySelector('[data-registe-type="sign-in"]');me&&(me.addEventListener("input",ge),ge()),A&&A.addEventListener("click",async o=>{var g,m,M,T;o.preventDefault(),s.log("Signin button clicked"),H();let l=((g=i("#email-login",e))==null?void 0:g.value)||((m=i('input[name="email-login"]',e))==null?void 0:m.value)||"",c=((M=i("#password-login",e))==null?void 0:M.value)||((T=i('input[name="password-login"]',e))==null?void 0:T.value)||"";if(s.log("Login attempt:",l),!l||!c){v(t,"Bitte E-Mail und Passwort eingeben");return}C(A,!0);try{await Q(l,c),E("Anmeldung erfolgreich!","success"),V(),R(),window.location.pathname.includes("/deine-bestellung")||re()}catch(x){s.error("Login error:",x),v(t,x.message)}finally{C(A,!1)}});let U=h('input[name^="code-"]',e);U.forEach((o,l)=>{o.addEventListener("input",c=>{c.target.value.length===1&&l<U.length-1&&U[l+1].focus()}),o.addEventListener("keydown",c=>{c.key==="Backspace"&&!c.target.value&&l>0&&U[l-1].focus()})});let F=i('[data-register="btn-code-confirm"]',e);F&&F.addEventListener("click",async o=>{o.preventDefault(),s.log("Code confirm clicked"),H();let l="";if(U.forEach(c=>{l+=c.value}),s.log("Code entered:",l),l.length!==6){v(t,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}C(F,!0);try{await X(l),E("E-Mail erfolgreich verifiziert!","success"),V(),R()}catch(c){s.error("Verification error:",c),v(t,c.message)}finally{C(F,!1)}});let pe=i('[data-register="code-resend"]',e);pe&&pe.addEventListener("click",async o=>{o.preventDefault(),s.log("Resend code clicked");try{await ee(),E("Code wurde erneut gesendet","success")}catch(l){s.error("Resend error:",l),E(l.message,"error")}});let fe=i('[data-register="password-forget"]',e);fe&&fe.addEventListener("click",o=>{o.preventDefault(),s.log("Password forget clicked"),E("Passwort-Reset wird noch implementiert","info")});let he=i('[data-register="google-signin"]',e);he&&he.addEventListener("click",o=>{o.preventDefault(),s.log("Google signin clicked"),E("Google-Anmeldung wird noch implementiert","info")});let ye=i('[data-register="apple-signin"]',e);ye&&ye.addEventListener("click",o=>{o.preventDefault(),s.log("Apple signin clicked"),E("Apple-Anmeldung wird noch implementiert","info")}),s.log("Auth handlers setup complete")}function R(){let e=$(),t=I();s.log("Updating auth UI, authenticated:",e,t),h('[data-auth-show="logged-in"]').forEach(r=>{r.style.display=e?"":"none"});let n=window.location.pathname,a=n==="/"||n==="/en"||n==="/en/"||n.includes("/vision");h('[data-auth-show="logged-out"]').forEach(r=>{r.classList.contains("nav_user")?a?r.style.display="none":r.style.display="":r.style.display=e?"none":""}),t&&(h('[data-auth-user="name"]').forEach(r=>{r.textContent=t.name}),h('[data-auth-user="email"]').forEach(r=>{r.textContent=t.email}))}let Ae="https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest";function re(){s.log("Opening Calendly modal");let e=I(),t=(e==null?void 0:e.name)||localStorage.getItem("userName")||"",n=(e==null?void 0:e.email)||localStorage.getItem("userEmail")||"",a=document.getElementById("calendly-modal-overlay");if(a){let p=document.getElementById("calendly-embed-container");p&&(p.innerHTML=""),a.style.display="flex",setTimeout(()=>{a.style.opacity="1"},10),le(t,n);return}a=document.createElement("div"),a.id="calendly-modal-overlay",a.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;";let r=document.createElement("div");r.style.cssText="background:#fff;border-radius:12px;width:90vw;max-width:700px;height:85vh;max-height:750px;position:relative;overflow:hidden;";let d=document.createElement("button");d.textContent="\u2715",d.style.cssText="position:absolute;top:12px;right:16px;z-index:10;background:none;border:none;font-size:20px;cursor:pointer;color:#333;",d.addEventListener("click",P);let u=document.createElement("div");u.id="calendly-embed-container",u.style.cssText="width:100%;height:100%;",r.appendChild(d),r.appendChild(u),a.appendChild(r),document.body.appendChild(a),a.addEventListener("click",p=>{p.target===a&&P()}),setTimeout(()=>{a.style.opacity="1"},10),le(t,n),Le()}function le(e,t){let n=document.getElementById("calendly-embed-container");if(!n)return;let a=Ae+"?hide_gdpr_banner=1";e&&(a+="&name="+encodeURIComponent(e)),t&&(a+="&email="+encodeURIComponent(t));let r=document.createElement("div");if(r.className="calendly-inline-widget",r.setAttribute("data-url",a),r.style.cssText="min-width:100%;height:100%;",n.appendChild(r),document.querySelector('script[src*="assets.calendly.com"]'))window.Calendly&&window.Calendly.initInlineWidget({url:a,parentElement:n});else{let d=document.createElement("script");d.src="https://assets.calendly.com/assets/external/widget.js",d.async=!0,document.body.appendChild(d)}s.log("Calendly widget injected with name:",e,"email:",t)}function Le(){window.addEventListener("message",e=>{var t,n,a,r,d;if(e.origin==="https://calendly.com"&&((t=e.data)==null?void 0:t.event)==="calendly.event_scheduled"){s.log("Calendly event scheduled:",e.data);let u=I(),p={userId:(u==null?void 0:u.id)||localStorage.getItem("userId"),userName:(u==null?void 0:u.name)||localStorage.getItem("userName"),userEmail:(u==null?void 0:u.email)||localStorage.getItem("userEmail"),eventUri:(a=(n=e.data.payload)==null?void 0:n.event)==null?void 0:a.uri,inviteeUri:(d=(r=e.data.payload)==null?void 0:r.invitee)==null?void 0:d.uri,scheduledAt:new Date().toISOString()};s.log("Booking data:",p),localStorage.setItem("lastBooking",JSON.stringify(p)),setTimeout(()=>{P(),E("Termin erfolgreich gebucht!","success")},1500)}})}function P(){let e=document.getElementById("calendly-modal-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300),s.log("Calendly modal closed"))}function G(){let e=document.getElementById("nav-user-dropdown");e&&e.remove()}function Ce(e){G();let t=I();if(!t)return;let n=document.createElement("div");n.id="nav-user-dropdown",n.style.cssText="position:absolute;top:100%;right:0;margin-top:8px;background:#1a1a2e;color:#fff;border-radius:10px;padding:16px 20px;min-width:220px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.3);font-family:inherit;";let a=document.createElement("div");a.textContent=t.name||"",a.style.cssText="font-size:15px;font-weight:600;margin-bottom:4px;";let r=document.createElement("div");r.textContent=t.email||"",r.style.cssText="font-size:13px;opacity:0.7;margin-bottom:14px;";let d=document.createElement("button");d.textContent="Abmelden",d.setAttribute("data-auth-logout",""),d.style.cssText="display:block;width:100%;padding:8px 0;background:none;border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:14px;cursor:pointer;transition:background 0.2s;",d.addEventListener("mouseenter",()=>{d.style.background="rgba(255,255,255,0.1)"}),d.addEventListener("mouseleave",()=>{d.style.background="none"}),n.appendChild(a),n.appendChild(r),n.appendChild(d);let u=e.closest(".nav_user")||e;u.style.position="relative",u.appendChild(n)}function Te(){let e=window.location.pathname;e==="/"||e==="/en"||e==="/en/"||e.includes("/vision")||document.addEventListener("click",n=>{let a=n.target.closest(".nav_user");if(!a){G();return}n.preventDefault(),$()?document.getElementById("nav-user-dropdown")?G():Ce(a):se()})}function Be(){document.addEventListener("click",e=>{e.target.closest("[data-auth-logout]")&&(e.preventDefault(),G(),te(),R(),E("Erfolgreich abgemeldet","info"),s.log("User logged out via button"))})}function de(){s.log("Initializing global auth module"),Ne(),Be(),Te(),R(),window.Auth={isAuthenticated:$,getCurrentUser:I,login:Q,register:Z,verifyEmail:X,resendCode:ee,logout:te,openModal:se,closeModal:V,openCalendly:re,closeCalendly:P,updateUI:R},s.log("Global auth module ready. Use Auth.openModal() to open.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",de):de()})();})();
