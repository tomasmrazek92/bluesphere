"use strict";(()=>{(function(){let M={API_BASE:"https://bluesphere.dev.longtermhealth.de",DEBUG:!0},p={TOKEN_KEY:"auth_token",REFRESH_KEY:"refresh_token",USER_KEY:"user_data"},a={log:(...e)=>M.DEBUG&&console.log("[AUTH]",...e),error:(...e)=>console.error("[AUTH]",...e)},s=(e,t=document)=>t.querySelector(e),v=(e,t=document)=>[...t.querySelectorAll(e)],f={set:function(e,t,n=60){let o={value:t,expiry:new Date().getTime()+n*60*1e3};try{sessionStorage.setItem(e,JSON.stringify(o))}catch(i){a.error("Storage error:",i)}},get:function(e){try{let t=sessionStorage.getItem(e);if(!t)return null;let n=JSON.parse(t);return new Date().getTime()>n.expiry?(sessionStorage.removeItem(e),null):n.value}catch{return null}},remove:function(e){sessionStorage.removeItem(e)}};async function A(e,t={}){let n=M.API_BASE+e,o=f.get(p.TOKEN_KEY),i={"Content-Type":"application/json",...t.headers};o&&(i.Authorization=`Bearer ${o}`),a.log("API Call:",e,t.method||"GET");try{let r=await fetch(n,{...t,headers:i});return a.log("API Response:",r.status),r}catch(r){throw a.error("API error:",r),r}}let z={firstName:"",lastName:"",email:"",password:""};async function Y(e){let{firstName:t,lastName:n,email:o,password:i,dateOfBirth:r,gender:l}=e;a.log("Registering user:",o);let u={firstName:t.trim(),lastName:n.trim(),email:o.toLowerCase().trim(),password:i,dateOfBirth:r,gender:l,role:"PATIENT"},m=await A("/user/registration",{method:"POST",body:JSON.stringify(u)});if(!m.ok){let C=await m.json().catch(()=>({}));throw new Error(C.statusMessage||C.message||"Registrierung fehlgeschlagen")}let h=await m.json();return a.log("Registration successful:",h),f.set(p.USER_KEY,{name:`${t} ${n}`,email:o,id:h.userId||h.id}),h}async function P(e,t){a.log("Logging in user:",e);let n=await A("/user/login",{method:"POST",body:JSON.stringify({email:e.toLowerCase().trim(),password:t})});if(!n.ok){let h=await n.json().catch(()=>({}));throw new Error(h.statusMessage||h.message||"Anmeldung fehlgeschlagen")}let o=await n.json();a.log("Login response:",o);let i=o.result||o,r=i.user||i,l=i.token||i.accessToken||o.token||o.accessToken,u=i.refreshToken||o.refreshToken;l?(f.set(p.TOKEN_KEY,l),a.log("Token stored")):a.log("Warning: No token in login response"),u&&f.set(p.REFRESH_KEY,u,60*24*7);let m={name:r.firstName?`${r.firstName} ${r.lastName}`:r.name,email:r.email||e,id:r.id};return f.set(p.USER_KEY,m),localStorage.setItem("userName",m.name),localStorage.setItem("userEmail",m.email),localStorage.setItem("userId",String(m.id)),a.log("Login successful"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),r}async function j(e){a.log("Verifying email with code:",e);let t=await A("/user/confirmation",{method:"POST",body:JSON.stringify({code:e.trim()})});if(!t.ok&&t.status!==201){let o=await t.json().catch(()=>({}));throw new Error(o.statusMessage||o.message||"Verifizierung fehlgeschlagen")}let n=await t.json();return a.log("Verification successful:",n),(n.token||n.accessToken)&&f.set(p.TOKEN_KEY,n.token||n.accessToken),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),n}async function G(){a.log("Resending verification code");let e=f.get(p.USER_KEY);if(!(e!=null&&e.email))throw new Error("Keine E-Mail-Adresse gefunden");let t=await A("/user/verification-code-resend",{method:"POST",body:JSON.stringify({email:e.email})});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.statusMessage||n.message||"Code konnte nicht gesendet werden")}return!0}function R(){let e=f.get(p.TOKEN_KEY),t=f.get(p.USER_KEY);return!!(e||t)}function x(){return f.get(p.USER_KEY)}function H(){f.remove(p.TOKEN_KEY),f.remove(p.REFRESH_KEY),f.remove(p.USER_KEY),localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userId"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!1}})),a.log("User logged out")}let Ee=0,F="login";function $(){return s('[data-modal-name="register"]')}function L(){let e=$();return e?v('[data-register="form-step"]',e):v('[data-register="form-step"]')}function I(e){L().forEach((n,o)=>{n.style.display=o===e?"block":"none"}),Ee=e,a.log("Showing step:",e)}function be(){let e=L();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="register"){I(t),F="register";return}}function V(){let e=L();for(let t=0;t<e.length;t++)if((e[t].getAttribute("data-registe-type")||e[t].getAttribute("data-register-type"))==="sign-in"){I(t),F="login";return}}function ke(){let e=L();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="code"){I(t);return}}function U(){I(0)}function J(){if(a.log("Opening register modal"),typeof window.openModal=="function")window.openModal("register"),setTimeout(()=>{U()},100);else{let e=s('[data-modal-target="register"]'),t=s('[data-modal-name="register"]'),n=s("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","active"),t&&t.setAttribute("data-modal-status","active"),n&&n.setAttribute("data-modal-group-status","active"),setTimeout(()=>{U()},100)}}function D(){if(typeof window.closeAllModals=="function")window.closeAllModals();else{let e=s('[data-modal-target="register"]'),t=s('[data-modal-name="register"]'),n=s("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","not-active"),t&&t.setAttribute("data-modal-status","not-active"),n&&n.setAttribute("data-modal-group-status","not-active")}}function w(e,t){let n=e.querySelector(".auth-error-message");if(!n){n=document.createElement("div"),n.className="auth-error-message",n.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;";let o=e.querySelector(".form_field-wrap");o?o.parentNode.insertBefore(n,o):e.prepend(n)}n.textContent=t,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)}function K(){v(".auth-error-message").forEach(e=>e.style.display="none")}function k(e,t){t?(e.setAttribute("data-loading","true"),e.style.opacity="0.7",e.style.pointerEvents="none"):(e.removeAttribute("data-loading"),e.style.opacity="1",e.style.pointerEvents="auto")}function E(e,t="info"){let n=document.createElement("div");n.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}function xe(){a.log("Setting up auth handlers");let e=$();if(!e){a.log("Register modal not found");return}let t=s('[data-register="form-wrap"]',e);if(!t){a.log("Auth form not found in register modal");return}a.log("Found form in register modal"),t.addEventListener("submit",d=>{d.preventDefault()});let n=s('[data-register="email-signin"]',e);n&&n.addEventListener("click",d=>{d.preventDefault(),a.log("Email signin clicked"),V()}),v('[data-register="register-link"]',e).forEach(d=>{d.addEventListener("click",c=>{c.preventDefault(),a.log("Register link clicked"),be()})}),v('[data-register="login-link"]',e).forEach(d=>{d.addEventListener("click",c=>{c.preventDefault(),a.log("Login link clicked"),V()})}),v('[data-register="btn-back"]',e).forEach(d=>{d.addEventListener("click",c=>{c.preventDefault(),a.log("Back button clicked"),U()})});let l=s('[data-register="btn-next"]',e);l&&l.addEventListener("click",async d=>{var ne,oe,ae,ie,se,re,le,de,ce,ue,ge,me,pe,fe,he,ye,ve;d.preventDefault(),a.log("Next button clicked (register)"),K();let c=((ne=s("#first_name",e))==null?void 0:ne.value)||((oe=s('input[name="first_name"]',e))==null?void 0:oe.value)||"",g=((ae=s("#last_name",e))==null?void 0:ae.value)||((ie=s('input[name="last_name"]',e))==null?void 0:ie.value)||"",b=((se=s("#email-sign-in",e))==null?void 0:se.value)||((re=s('input[name="email-sign-in"]',e))==null?void 0:re.value)||"",y=((le=s("#password-signin",e))==null?void 0:le.value)||((de=s('input[name="password-signin"]',e))==null?void 0:de.value)||"",_=((ce=s("#password-signin-again",e))==null?void 0:ce.value)||((ue=s('input[name="password-signin-again"]',e))==null?void 0:ue.value)||"";if(a.log("Form values:",{firstName:c,lastName:g,email:b,hasPassword:!!y}),!c||!g){w(t,"Bitte Vor- und Nachnamen eingeben");return}if(!b||!b.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){w(t,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}if(!y||y.length<8||!/[A-Z]/.test(y)||!/[a-z]/.test(y)||!/[0-9]/.test(y)||!/[^A-Za-z0-9]/.test(y)){w(t,"Passwort: min. 8 Zeichen, 1 Gro\xDFbuchstabe, 1 Kleinbuchstabe, 1 Zahl und 1 Sonderzeichen");return}if(y!==_){w(t,"Passw\xF6rter stimmen nicht \xFCberein");return}let T=((ge=s("#date-of-birth",e))==null?void 0:ge.value)||((me=s('input[name="date-of-birth"]',e))==null?void 0:me.value)||((pe=s('input[name="dateOfBirth"]',e))==null?void 0:pe.value)||((fe=s('input[type="date"]',e))==null?void 0:fe.value)||"";if(!T){w(t,"Bitte Geburtsdatum eingeben");return}let O=new Date(T).toISOString().split("T")[0],te=((he=s("#gender-register",e))==null?void 0:he.value)||((ye=s('select[name="gender-register"]',e))==null?void 0:ye.value)||((ve=s('select[name="gender"]',e))==null?void 0:ve.value)||"";if(!te){w(t,"Bitte Geschlecht ausw\xE4hlen");return}z={firstName:c,lastName:g,email:b,password:y,dateOfBirth:O,gender:te},k(l,!0);try{await Y(z),E("Registrierung erfolgreich! Bitte Code eingeben.","success"),ke()}catch(we){a.error("Registration error:",we),w(t,we.message)}finally{k(l,!1)}});let u=s('[data-register="btn-signin"]',e);u&&u.addEventListener("click",async d=>{var b,y,_,T;d.preventDefault(),a.log("Signin button clicked"),K();let c=((b=s("#email-login",e))==null?void 0:b.value)||((y=s('input[name="email-login"]',e))==null?void 0:y.value)||"",g=((_=s("#password-login",e))==null?void 0:_.value)||((T=s('input[name="password-login"]',e))==null?void 0:T.value)||"";if(a.log("Login attempt:",c),!c||!g){w(t,"Bitte E-Mail und Passwort eingeben");return}k(u,!0);try{await P(c,g),E("Anmeldung erfolgreich!","success"),D(),S(),window.location.pathname.includes("/deine-bestellung")||q()}catch(O){a.error("Login error:",O),w(t,O.message)}finally{k(u,!1)}});let m=v('input[name^="code-"]',e);m.forEach((d,c)=>{d.addEventListener("input",g=>{g.target.value.length===1&&c<m.length-1&&m[c+1].focus()}),d.addEventListener("keydown",g=>{g.key==="Backspace"&&!g.target.value&&c>0&&m[c-1].focus()})});let h=s('[data-register="btn-code-confirm"]',e);h&&h.addEventListener("click",async d=>{d.preventDefault(),a.log("Code confirm clicked"),K();let c="";if(m.forEach(g=>{c+=g.value}),a.log("Code entered:",c),c.length!==6){w(t,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}k(h,!0);try{await j(c),E("E-Mail erfolgreich verifiziert!","success"),D(),S()}catch(g){a.error("Verification error:",g),w(t,g.message)}finally{k(h,!1)}});let C=s('[data-register="code-resend"]',e);C&&C.addEventListener("click",async d=>{d.preventDefault(),a.log("Resend code clicked");try{await G(),E("Code wurde erneut gesendet","success")}catch(c){a.error("Resend error:",c),E(c.message,"error")}});let Q=s('[data-register="password-forget"]',e);Q&&Q.addEventListener("click",d=>{d.preventDefault(),a.log("Password forget clicked"),E("Passwort-Reset wird noch implementiert","info")});let X=s('[data-register="google-signin"]',e);X&&X.addEventListener("click",d=>{d.preventDefault(),a.log("Google signin clicked"),E("Google-Anmeldung wird noch implementiert","info")});let ee=s('[data-register="apple-signin"]',e);ee&&ee.addEventListener("click",d=>{d.preventDefault(),a.log("Apple signin clicked"),E("Apple-Anmeldung wird noch implementiert","info")}),a.log("Auth handlers setup complete")}function S(){let e=R(),t=x();a.log("Updating auth UI, authenticated:",e,t),v('[data-auth-show="logged-in"]').forEach(i=>{i.style.display=e?"":"none"});let n=window.location.pathname,o=n==="/"||n==="/en"||n==="/en/"||n.includes("/vision");v('[data-auth-show="logged-out"]').forEach(i=>{i.classList.contains("nav_user")?o?i.style.display="none":i.style.display="":i.style.display=e?"none":""}),t&&(v('[data-auth-user="name"]').forEach(i=>{i.textContent=t.name}),v('[data-auth-user="email"]').forEach(i=>{i.textContent=t.email}))}let Se="https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest";function q(){a.log("Opening Calendly modal");let e=x(),t=(e==null?void 0:e.name)||localStorage.getItem("userName")||"",n=(e==null?void 0:e.email)||localStorage.getItem("userEmail")||"",o=document.getElementById("calendly-modal-overlay");if(o){let u=document.getElementById("calendly-embed-container");u&&(u.innerHTML=""),o.style.display="flex",setTimeout(()=>{o.style.opacity="1"},10),Z(t,n);return}o=document.createElement("div"),o.id="calendly-modal-overlay",o.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;";let i=document.createElement("div");i.style.cssText="background:#fff;border-radius:12px;width:90vw;max-width:700px;height:85vh;max-height:750px;position:relative;overflow:hidden;";let r=document.createElement("button");r.textContent="\u2715",r.style.cssText="position:absolute;top:12px;right:16px;z-index:10;background:none;border:none;font-size:20px;cursor:pointer;color:#333;",r.addEventListener("click",N);let l=document.createElement("div");l.id="calendly-embed-container",l.style.cssText="width:100%;height:100%;",i.appendChild(r),i.appendChild(l),o.appendChild(i),document.body.appendChild(o),o.addEventListener("click",u=>{u.target===o&&N()}),setTimeout(()=>{o.style.opacity="1"},10),Z(t,n),Ce()}function Z(e,t){let n=document.getElementById("calendly-embed-container");if(!n)return;let o=Se+"?hide_gdpr_banner=1";e&&(o+="&name="+encodeURIComponent(e)),t&&(o+="&email="+encodeURIComponent(t));let i=document.createElement("div");if(i.className="calendly-inline-widget",i.setAttribute("data-url",o),i.style.cssText="min-width:100%;height:100%;",n.appendChild(i),document.querySelector('script[src*="assets.calendly.com"]'))window.Calendly&&window.Calendly.initInlineWidget({url:o,parentElement:n});else{let r=document.createElement("script");r.src="https://assets.calendly.com/assets/external/widget.js",r.async=!0,document.body.appendChild(r)}a.log("Calendly widget injected with name:",e,"email:",t)}function Ce(){window.addEventListener("message",e=>{var t,n,o,i,r;if(e.origin==="https://calendly.com"&&((t=e.data)==null?void 0:t.event)==="calendly.event_scheduled"){a.log("Calendly event scheduled:",e.data);let l=x(),u={userId:(l==null?void 0:l.id)||localStorage.getItem("userId"),userName:(l==null?void 0:l.name)||localStorage.getItem("userName"),userEmail:(l==null?void 0:l.email)||localStorage.getItem("userEmail"),eventUri:(o=(n=e.data.payload)==null?void 0:n.event)==null?void 0:o.uri,inviteeUri:(r=(i=e.data.payload)==null?void 0:i.invitee)==null?void 0:r.uri,scheduledAt:new Date().toISOString()};a.log("Booking data:",u),localStorage.setItem("lastBooking",JSON.stringify(u)),setTimeout(()=>{N(),E("Termin erfolgreich gebucht!","success")},1500)}})}function N(){let e=document.getElementById("calendly-modal-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300),a.log("Calendly modal closed"))}function B(){let e=document.getElementById("nav-user-dropdown");e&&e.remove()}function Te(e){B();let t=x();if(!t)return;let n=document.createElement("div");n.id="nav-user-dropdown",n.style.cssText="position:absolute;top:100%;right:0;margin-top:8px;background:#1a1a2e;color:#fff;border-radius:10px;padding:16px 20px;min-width:220px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.3);font-family:inherit;";let o=document.createElement("div");o.textContent=t.name||"",o.style.cssText="font-size:15px;font-weight:600;margin-bottom:4px;";let i=document.createElement("div");i.textContent=t.email||"",i.style.cssText="font-size:13px;opacity:0.7;margin-bottom:14px;";let r=document.createElement("button");r.textContent="Abmelden",r.setAttribute("data-auth-logout",""),r.style.cssText="display:block;width:100%;padding:8px 0;background:none;border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:14px;cursor:pointer;transition:background 0.2s;",r.addEventListener("mouseenter",()=>{r.style.background="rgba(255,255,255,0.1)"}),r.addEventListener("mouseleave",()=>{r.style.background="none"}),n.appendChild(o),n.appendChild(i),n.appendChild(r);let l=e.closest(".nav_user")||e;l.style.position="relative",l.appendChild(n)}function Ae(){let e=window.location.pathname;e==="/"||e==="/en"||e==="/en/"||e.includes("/vision")||document.addEventListener("click",n=>{let o=n.target.closest(".nav_user");if(!o){B();return}n.preventDefault(),R()?document.getElementById("nav-user-dropdown")?B():Te(o):J()})}function Le(){document.addEventListener("click",e=>{e.target.closest("[data-auth-logout]")&&(e.preventDefault(),B(),H(),S(),E("Erfolgreich abgemeldet","info"),a.log("User logged out via button"))})}function W(){a.log("Initializing global auth module"),xe(),Le(),Ae(),S(),window.Auth={isAuthenticated:R,getCurrentUser:x,login:P,register:Y,verifyEmail:j,resendCode:G,logout:H,openModal:J,closeModal:D,openCalendly:q,closeCalendly:N,updateUI:S},a.log("Global auth module ready. Use Auth.openModal() to open.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):W()})();})();
