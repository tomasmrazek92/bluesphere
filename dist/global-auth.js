"use strict";(()=>{(function(){let B={API_BASE:"https://bluesphere.dev.longtermhealth.de",DEBUG:!0},u={TOKEN_KEY:"auth_token",REFRESH_KEY:"refresh_token",USER_KEY:"user_data"},o={log:(...e)=>B.DEBUG&&console.log("[AUTH]",...e),error:(...e)=>console.error("[AUTH]",...e)},r=(e,t=document)=>t.querySelector(e),f=(e,t=document)=>[...t.querySelectorAll(e)],g={set:function(e,t,n=60){let i={value:t,expiry:new Date().getTime()+n*60*1e3};try{sessionStorage.setItem(e,JSON.stringify(i))}catch(l){o.error("Storage error:",l)}},get:function(e){try{let t=sessionStorage.getItem(e);if(!t)return null;let n=JSON.parse(t);return new Date().getTime()>n.expiry?(sessionStorage.removeItem(e),null):n.value}catch{return null}},remove:function(e){sessionStorage.removeItem(e)}};async function M(e){let n=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join("")}async function T(e,t={}){let n=B.API_BASE+e,i=g.get(u.TOKEN_KEY),l={"Content-Type":"application/json",...t.headers};i&&(l.Authorization=`Bearer ${i}`),o.log("API Call:",e,t.method||"GET");try{let c=await fetch(n,{...t,headers:l});return o.log("API Response:",c.status),c}catch(c){throw o.error("API error:",c),c}}let O={firstName:"",lastName:"",email:"",password:""};async function U(e){let{firstName:t,lastName:n,email:i,password:l}=e;o.log("Registering user:",i);let c=await M(l),w={firstName:t.trim(),lastName:n.trim(),email:i.toLowerCase().trim(),password:c,role:"PATIENT"},m=await T("/user/registration",{method:"POST",body:JSON.stringify(w)});if(!m.ok){let k=await m.json().catch(()=>({}));throw new Error(k.statusMessage||k.message||"Registrierung fehlgeschlagen")}let p=await m.json();return o.log("Registration successful:",p),g.set(u.USER_KEY,{name:`${t} ${n}`,email:i,id:p.userId||p.id}),p}async function P(e,t){var w;o.log("Logging in user:",e);let n=await M(t),i=await T("/user/login",{method:"POST",body:JSON.stringify({email:e.toLowerCase().trim(),password:n})});if(!i.ok){let m=await i.json().catch(()=>({}));throw new Error(m.statusMessage||m.message||"Anmeldung fehlgeschlagen")}let l=await i.json();o.log("Login response:",l);let c=((w=l.result)==null?void 0:w.user)||l.user||l;return(l.token||l.accessToken)&&g.set(u.TOKEN_KEY,l.token||l.accessToken),l.refreshToken&&g.set(u.REFRESH_KEY,l.refreshToken,60*24*7),g.set(u.USER_KEY,{name:c.firstName?`${c.firstName} ${c.lastName}`:c.name,email:c.email,id:c.id}),o.log("Login successful"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),c}async function D(e){o.log("Verifying email with code:",e);let t=await T("/user/confirmation",{method:"POST",body:JSON.stringify({code:e.trim()})});if(!t.ok&&t.status!==201){let i=await t.json().catch(()=>({}));throw new Error(i.statusMessage||i.message||"Verifizierung fehlgeschlagen")}let n=await t.json();return o.log("Verification successful:",n),(n.token||n.accessToken)&&g.set(u.TOKEN_KEY,n.token||n.accessToken),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),n}async function I(){o.log("Resending verification code");let e=g.get(u.USER_KEY);if(!(e!=null&&e.email))throw new Error("Keine E-Mail-Adresse gefunden");let t=await T("/user/verification-code-resend",{method:"POST",body:JSON.stringify({email:e.email})});if(!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.statusMessage||n.message||"Code konnte nicht gesendet werden")}return!0}function Y(){let e=g.get(u.TOKEN_KEY),t=g.get(u.USER_KEY);return!!(e&&t)}function F(){return g.get(u.USER_KEY)}function se(){g.remove(u.TOKEN_KEY),g.remove(u.REFRESH_KEY),g.remove(u.USER_KEY),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!1}})),o.log("User logged out")}let ae=0,G="login";function $(){return r('[data-modal-name="register"]')}function N(){let e=$();return e?f('[data-register="form-step"]',e):f('[data-register="form-step"]')}function L(e){N().forEach((n,i)=>{n.style.display=i===e?"block":"none"}),ae=e,o.log("Showing step:",e)}function ie(){let e=N();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="register"){L(t),G="register";return}}function j(){let e=N();for(let t=0;t<e.length;t++)if((e[t].getAttribute("data-registe-type")||e[t].getAttribute("data-register-type"))==="sign-in"){L(t),G="login";return}}function le(){let e=N();for(let t=0;t<e.length;t++)if(e[t].getAttribute("data-register-type")==="code"){L(t);return}}function _(){L(0)}function ce(){if(o.log("Opening register modal"),typeof window.openModal=="function")window.openModal("register"),setTimeout(()=>{_()},100);else{let e=r('[data-modal-target="register"]'),t=r('[data-modal-name="register"]'),n=r("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","active"),t&&t.setAttribute("data-modal-status","active"),n&&n.setAttribute("data-modal-group-status","active"),setTimeout(()=>{_()},100)}}function K(){if(typeof window.closeAllModals=="function")window.closeAllModals();else{let e=r('[data-modal-target="register"]'),t=r('[data-modal-name="register"]'),n=r("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","not-active"),t&&t.setAttribute("data-modal-status","not-active"),n&&n.setAttribute("data-modal-group-status","not-active")}}function h(e,t){let n=e.querySelector(".auth-error-message");if(!n){n=document.createElement("div"),n.className="auth-error-message",n.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;";let i=e.querySelector(".form_field-wrap");i?i.parentNode.insertBefore(n,i):e.prepend(n)}n.textContent=t,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)}function x(){f(".auth-error-message").forEach(e=>e.style.display="none")}function S(e,t){t?(e.setAttribute("data-loading","true"),e.style.opacity="0.7",e.style.pointerEvents="none"):(e.removeAttribute("data-loading"),e.style.opacity="1",e.style.pointerEvents="auto")}function E(e,t="info"){let n=document.createElement("div");n.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${t==="success"?"#00a86b":t==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}function de(){o.log("Setting up auth handlers");let e=$();if(!e){o.log("Register modal not found");return}let t=r('[data-register="form-wrap"]',e);if(!t){o.log("Auth form not found in register modal");return}o.log("Found form in register modal"),t.addEventListener("submit",s=>{s.preventDefault()});let n=r('[data-register="email-signin"]',e);n&&n.addEventListener("click",s=>{s.preventDefault(),o.log("Email signin clicked"),j()}),f('[data-register="register-link"]',e).forEach(s=>{s.addEventListener("click",a=>{a.preventDefault(),o.log("Register link clicked"),ie()})}),f('[data-register="login-link"]',e).forEach(s=>{s.addEventListener("click",a=>{a.preventDefault(),o.log("Login link clicked"),j()})}),f('[data-register="btn-back"]',e).forEach(s=>{s.addEventListener("click",a=>{a.preventDefault(),o.log("Back button clicked"),_()})});let w=r('[data-register="btn-next"]',e);w&&w.addEventListener("click",async s=>{var A,b,Z,Q,W,X,ee,te,ne,oe;s.preventDefault(),o.log("Next button clicked (register)"),x();let a=((A=r("#first_name",e))==null?void 0:A.value)||((b=r('input[name="first_name"]',e))==null?void 0:b.value)||"",d=((Z=r("#last_name",e))==null?void 0:Z.value)||((Q=r('input[name="last_name"]',e))==null?void 0:Q.value)||"",y=((W=r("#email-sign-in",e))==null?void 0:W.value)||((X=r('input[name="email-sign-in"]',e))==null?void 0:X.value)||"",v=((ee=r("#password-signin",e))==null?void 0:ee.value)||((te=r('input[name="password-signin"]',e))==null?void 0:te.value)||"",C=((ne=r("#password-signin-again",e))==null?void 0:ne.value)||((oe=r('input[name="password-signin-again"]',e))==null?void 0:oe.value)||"";if(o.log("Form values:",{firstName:a,lastName:d,email:y,hasPassword:!!v}),!a||!d){h(t,"Bitte Vor- und Nachnamen eingeben");return}if(!y||!y.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){h(t,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}if(!v||v.length<8){h(t,"Passwort muss mindestens 8 Zeichen haben");return}if(v!==C){h(t,"Passw\xF6rter stimmen nicht \xFCberein");return}O={firstName:a,lastName:d,email:y,password:v},S(w,!0);try{await U(O),E("Registrierung erfolgreich! Bitte Code eingeben.","success"),le()}catch(re){o.error("Registration error:",re),h(t,re.message)}finally{S(w,!1)}});let m=r('[data-register="btn-signin"]',e);m&&m.addEventListener("click",async s=>{var y,v,C,A;s.preventDefault(),o.log("Signin button clicked"),x();let a=((y=r("#email-login",e))==null?void 0:y.value)||((v=r('input[name="email-login"]',e))==null?void 0:v.value)||"",d=((C=r("#password-login",e))==null?void 0:C.value)||((A=r('input[name="password-login"]',e))==null?void 0:A.value)||"";if(o.log("Login attempt:",a),!a||!d){h(t,"Bitte E-Mail und Passwort eingeben");return}S(m,!0);try{await P(a,d),E("Anmeldung erfolgreich!","success"),K(),R()}catch(b){o.error("Login error:",b),h(t,b.message)}finally{S(m,!1)}});let p=f('input[name^="code-"]',e);p.forEach((s,a)=>{s.addEventListener("input",d=>{d.target.value.length===1&&a<p.length-1&&p[a+1].focus()}),s.addEventListener("keydown",d=>{d.key==="Backspace"&&!d.target.value&&a>0&&p[a-1].focus()})});let k=r('[data-register="btn-code-confirm"]',e);k&&k.addEventListener("click",async s=>{s.preventDefault(),o.log("Code confirm clicked"),x();let a="";if(p.forEach(d=>{a+=d.value}),o.log("Code entered:",a),a.length!==6){h(t,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}S(k,!0);try{await D(a),E("E-Mail erfolgreich verifiziert!","success"),K(),R()}catch(d){o.error("Verification error:",d),h(t,d.message)}finally{S(k,!1)}});let z=r('[data-register="code-resend"]',e);z&&z.addEventListener("click",async s=>{s.preventDefault(),o.log("Resend code clicked");try{await I(),E("Code wurde erneut gesendet","success")}catch(a){o.error("Resend error:",a),E(a.message,"error")}});let J=r('[data-register="password-forget"]',e);J&&J.addEventListener("click",s=>{s.preventDefault(),o.log("Password forget clicked"),E("Passwort-Reset wird noch implementiert","info")});let V=r('[data-register="google-signin"]',e);V&&V.addEventListener("click",s=>{s.preventDefault(),o.log("Google signin clicked"),E("Google-Anmeldung wird noch implementiert","info")});let q=r('[data-register="apple-signin"]',e);q&&q.addEventListener("click",s=>{s.preventDefault(),o.log("Apple signin clicked"),E("Apple-Anmeldung wird noch implementiert","info")}),o.log("Auth handlers setup complete")}function R(){let e=Y(),t=F();o.log("Updating auth UI, authenticated:",e,t),f('[data-auth-show="logged-in"]').forEach(n=>{n.style.display=e?"":"none"}),f('[data-auth-show="logged-out"]').forEach(n=>{n.style.display=e?"none":""}),t&&(f('[data-auth-user="name"]').forEach(n=>{n.textContent=t.name}),f('[data-auth-user="email"]').forEach(n=>{n.textContent=t.email}))}function H(){o.log("Initializing global auth module"),de(),R(),window.Auth={isAuthenticated:Y,getCurrentUser:F,login:P,register:U,verifyEmail:D,resendCode:I,logout:se,openModal:ce,closeModal:K,updateUI:R},o.log("Global auth module ready. Use Auth.openModal() to open.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",H):H()})();})();
