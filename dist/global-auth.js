"use strict";(()=>{(function(){let te={API_BASE:"https://bluesphere.dev.longtermhealth.de",DEBUG:!0},w={TOKEN_KEY:"auth_token",REFRESH_KEY:"refresh_token",USER_KEY:"user_data"},l={log:(...e)=>te.DEBUG&&console.log("[AUTH]",...e),error:(...e)=>console.error("[AUTH]",...e)},c=(e,n=document)=>n.querySelector(e),v=(e,n=document)=>[...n.querySelectorAll(e)],E={set:function(e,n,o=60){let r={value:n,expiry:new Date().getTime()+o*60*1e3};try{sessionStorage.setItem(e,JSON.stringify(r))}catch(d){l.error("Storage error:",d)}},get:function(e){try{let n=sessionStorage.getItem(e);if(!n)return null;let o=JSON.parse(n);return new Date().getTime()>o.expiry?(sessionStorage.removeItem(e),null):o.value}catch{return null}},remove:function(e){sessionStorage.removeItem(e)}};async function G(e,n={}){let o=te.API_BASE+e,r=E.get(w.TOKEN_KEY),d={"Content-Type":"application/json",...n.headers};r&&(d.Authorization=`Bearer ${r}`),l.log("API Call:",e,n.method||"GET");try{let u=await fetch(o,{...n,headers:d});return l.log("API Response:",u.status),u}catch(u){throw l.error("API error:",u),u}}let I={firstName:"",lastName:"",email:"",password:""},ne={male:"MALE",female:"FEMALE",diverse:"OTHER","non-binary":"NON_BINARY",other:"OTHER","no-share":"NO_SHARE",unknown:"UNKNOWN",MALE:"MALE",FEMALE:"FEMALE",NON_BINARY:"NON_BINARY",OTHER:"OTHER",NO_SHARE:"NO_SHARE",UNKNOWN:"UNKNOWN"};async function ie(e){let{firstName:n,lastName:o,email:r,password:d,dateOfBirth:u,gender:g}=e;l.log("Registering user:",r);let p=ne[g]||ne[g.toLowerCase()]||"UNKNOWN",m={firstName:n.trim(),lastName:o.trim(),email:r.toLowerCase().trim(),password:d,dateOfBirth:u,gender:p,role:"PATIENT"},h=await G("/user/registration",{method:"POST",body:JSON.stringify(m)});if(!h.ok){let T=await h.json().catch(()=>({}));throw new Error(T.statusMessage||T.message||"Registrierung fehlgeschlagen")}let L=await h.json();return l.log("Registration successful:",L),E.set(w.USER_KEY,{name:`${n} ${o}`,email:r,id:L.userId||L.id}),L}async function oe(e,n){l.log("Logging in user:",e);let o=await G("/user/login",{method:"POST",body:JSON.stringify({email:e.toLowerCase().trim(),password:n})});if(!o.ok){let h=await o.json().catch(()=>({}));throw new Error(h.statusMessage||h.message||"Anmeldung fehlgeschlagen")}let r=await o.json();l.log("Login response:",r);let d=r.result||r,u=d.user||d,g=d.token||d.accessToken||r.token||r.accessToken,p=d.refreshToken||r.refreshToken;g?(E.set(w.TOKEN_KEY,g),l.log("Token stored")):l.log("Warning: No token in login response"),p&&E.set(w.REFRESH_KEY,p,60*24*7);let m={name:u.firstName?`${u.firstName} ${u.lastName}`:u.name,email:u.email||e,id:u.id};return E.set(w.USER_KEY,m),localStorage.setItem("userName",m.name),localStorage.setItem("userEmail",m.email),localStorage.setItem("userId",String(m.id)),l.log("Login successful"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),u}async function re(e){l.log("Verifying email with code:",e);let n=await G("/user/confirmation",{method:"POST",body:JSON.stringify({code:e.trim()})});if(!n.ok&&n.status!==201){let r=await n.json().catch(()=>({}));throw new Error(r.statusMessage||r.message||"Verifizierung fehlgeschlagen")}let o=await n.json();return l.log("Verification successful:",o),(o.token||o.accessToken)&&E.set(w.TOKEN_KEY,o.token||o.accessToken),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!0}})),o}async function ae(){l.log("Resending verification code");let e=E.get(w.USER_KEY);if(!(e!=null&&e.email))throw new Error("Keine E-Mail-Adresse gefunden");let n=await G("/user/verification-code-resend",{method:"POST",body:JSON.stringify({email:e.email})});if(!n.ok){let o=await n.json().catch(()=>({}));throw new Error(o.statusMessage||o.message||"Code konnte nicht gesendet werden")}return!0}function Z(){let e=E.get(w.TOKEN_KEY),n=E.get(w.USER_KEY);return!!(e||n)}function R(){return E.get(w.USER_KEY)}function se(){E.remove(w.TOKEN_KEY),E.remove(w.REFRESH_KEY),E.remove(w.USER_KEY),localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userId"),window.dispatchEvent(new CustomEvent("auth-changed",{detail:{authenticated:!1}})),l.log("User logged out")}let Ae=0,le="login";function ce(){return c('[data-modal-name="register"]')}function M(){let e=ce();return e?v('[data-register="form-step"]',e):v('[data-register="form-step"]')}function q(e){M().forEach((o,r)=>{o.style.display=r===e?"block":"none"}),Ae=e,l.log("Showing step:",e)}function W(){let e=M();for(let n=0;n<e.length;n++)if(e[n].getAttribute("data-register-type")==="register"){q(n),le="register";return}}function Q(){let e=M();for(let n=0;n<e.length;n++)if((e[n].getAttribute("data-registe-type")||e[n].getAttribute("data-register-type"))==="sign-in"){q(n),le="login";return}}function Ne(){let e=M();for(let n=0;n<e.length;n++)if(e[n].getAttribute("data-register-type")==="personal-info"){q(n),setTimeout(()=>{let r=e[n].querySelector('input[data-toggle="datepicker"]');if(l.log("Personal-info step: datepicker input:",r?"found":"not found"),r){if(window.jQuery)try{let g=window.jQuery(r);g.datepicker&&!g.data("datepicker")?(g.datepicker({format:"dd.mm.yyyy",autoHide:!0}),l.log("Datepicker initialized")):l.log("Datepicker already initialized or not available")}catch(g){l.log("Datepicker init failed:",g.message)}let d=r.closest(".form_field"),u=d==null?void 0:d.querySelector(".form_field-icon");l.log("Calendar icon:",u?"found":"not found"),u&&!u._dpBound&&(u._dpBound=!0,u.style.cursor="pointer",u.addEventListener("click",g=>{if(g.preventDefault(),g.stopPropagation(),l.log("Calendar icon clicked"),r.focus(),r.click(),window.jQuery)try{window.jQuery(r).datepicker("show")}catch{}}))}},200);return}}function Be(){let e=M();for(let n=0;n<e.length;n++)if(e[n].getAttribute("data-register-type")==="code"){q(n);return}}function de(){q(0)}function Y(e){if(l.log("Opening register modal, step:",e||"initial"),typeof window.openModal=="function")window.openModal("register");else{let n=c('[data-modal-target="register"]'),o=c('[data-modal-name="register"]'),r=c("[data-modal-group-status]");n&&n.setAttribute("data-modal-status","active"),o&&o.setAttribute("data-modal-status","active"),r&&r.setAttribute("data-modal-group-status","active")}setTimeout(()=>{e==="register"?W():e==="login"?Q():de()},100)}function X(){if(typeof window.closeAllModals=="function")window.closeAllModals();else{let e=c('[data-modal-target="register"]'),n=c('[data-modal-name="register"]'),o=c("[data-modal-group-status]");e&&e.setAttribute("data-modal-status","not-active"),n&&n.setAttribute("data-modal-status","not-active"),o&&o.setAttribute("data-modal-group-status","not-active")}}function b(e,n){let o=e.querySelector(".auth-error-message");if(!o){o=document.createElement("div"),o.className="auth-error-message",o.style.cssText="color: #dc3545; padding: 10px; margin: 10px 0; background: #f8d7da; border-radius: 4px; font-size: 14px;";let r=e.querySelector(".form_field-wrap");r?r.parentNode.insertBefore(o,r):e.prepend(o)}o.textContent=n,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3)}function $(){v(".auth-error-message").forEach(e=>e.style.display="none"),v(".form_validation.show").forEach(e=>e.classList.remove("show")),v(".form_field.error").forEach(e=>e.classList.remove("error"))}function _(e,n){n?(e.setAttribute("data-loading","true"),e.style.opacity="0.7",e.style.pointerEvents="none"):(e.removeAttribute("data-loading"),e.style.opacity="1",e.style.pointerEvents="auto")}function k(e,n="info"){var d;let o=((d=document.querySelector(".navbar"))==null?void 0:d.getBoundingClientRect().bottom)||80,r=document.createElement("div");r.style.cssText=`position:fixed;top:${o+8}px;right:20px;padding:16px 24px;background:${n==="success"?"#00a86b":n==="error"?"#dc3545":"#333"};color:white;border-radius:8px;z-index:10001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;`,r.textContent=e,document.body.appendChild(r),setTimeout(()=>{r.style.opacity="0",setTimeout(()=>r.remove(),300)},3e3)}function Ce(){l.log("Setting up auth handlers");let e=ce();if(!e){l.log("Register modal not found");return}let n=c('[data-register="form-wrap"]',e);if(!n){l.log("Auth form not found in register modal");return}l.log("Found form in register modal"),e.querySelectorAll('input[type="password"], input[data-toggle="datepicker"]').forEach(t=>{let i=t.closest(".form_field");if(i&&!i.querySelector(".form_label")){let a=document.createElement("label");a.className="form_label",a.setAttribute("for",t.id||""),a.textContent=t.placeholder||"",i.appendChild(a)}}),n.addEventListener("submit",t=>{t.preventDefault()});let o=c('[data-register="email-signin"]',e);o&&o.addEventListener("click",t=>{t.preventDefault(),l.log("Email signin clicked"),Q()}),v('[data-register="register-link"]',e).forEach(t=>{t.addEventListener("click",i=>{i.preventDefault(),l.log("Register link clicked"),W()})}),v('[data-register="login-link"]',e).forEach(t=>{t.addEventListener("click",i=>{i.preventDefault(),l.log("Login link clicked"),Q()})}),v('[data-register="btn-back"]',e).forEach(t=>{t.addEventListener("click",i=>{i.preventDefault(),l.log("Back button clicked");let a=t.closest('[data-register="form-step"]');a&&a.getAttribute("data-register-type")==="personal-info"?W():de()})});let g=c('[data-register="btn-next"]',e);function p(){var t,i,a,s,f;return{firstName:((t=c("#first_name",e)||c('input[name="first_name"]',e))==null?void 0:t.value)||"",lastName:((i=c("#last_name",e)||c('input[name="last_name"]',e))==null?void 0:i.value)||"",email:((a=c("#email-sign-in",e)||c('input[name="email-sign-in"]',e))==null?void 0:a.value)||"",password:((s=c("#password-signin",e)||c('input[name="password-signin"]',e))==null?void 0:s.value)||"",passwordConfirm:((f=c("#password-signin-again",e)||c('input[name="password-signin-again"]',e))==null?void 0:f.value)||""}}function m(t,i){let a=t.closest(".form_field-wrap");if(!a)return;let s=a.querySelector(".form_field");s&&s.classList.add("error");let f=a.querySelector(".form_validation");f&&(f.textContent=i,f.classList.add("show"))}function h(t){let i=t.closest(".form_field-wrap");if(!i)return;let a=i.querySelector(".form_field");a&&a.classList.remove("error");let s=i.querySelector(".form_validation");s&&s.classList.remove("show")}function L(t){if(!t)return;let i=t.value;i&&(i.length<8||!/[A-Z]/.test(i)||!/[a-z]/.test(i)||!/[0-9]/.test(i)||!/[^A-Za-z0-9]/.test(i)?m(t,"Mindestens 8 Zeichen, Gro\xDF-/Kleinbuchstabe, Zahl und Sonderzeichen"):h(t))}function T(t,i){if(!t||!i)return;let a=t.value;a&&(a!==i.value?m(t,"Passw\xF6rter stimmen nicht \xFCberein"):h(t))}function Me(){let t=p();return!(!t.firstName||!t.lastName||!t.email||!t.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)||!t.password||t.password.length<8||!/[A-Z]/.test(t.password)||!/[a-z]/.test(t.password)||!/[0-9]/.test(t.password)||!/[^A-Za-z0-9]/.test(t.password)||t.password!==t.passwordConfirm)}function pe(){if(!g)return;let t=Me();g.style.opacity=t?"":"0.5",g.style.pointerEvents=t?"auto":"none"}let x=e.querySelector('[data-register-type="register"]');if(x){x.addEventListener("input",pe),pe();let t=x.querySelector('#first_name, input[name="first_name"]'),i=x.querySelector('#last_name, input[name="last_name"]'),a=x.querySelector('#email-sign-in, input[name="email-sign-in"]'),s=x.querySelector('#password-signin, input[name="password-signin"]'),f=x.querySelector('#password-signin-again, input[name="password-signin-again"]');t&&t.addEventListener("input",()=>{t.value.trim()&&h(t)}),i&&i.addEventListener("input",()=>{i.value.trim()&&h(i)}),a&&a.addEventListener("input",()=>{a.value&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.value)&&h(a)}),s&&s.addEventListener("input",()=>{L(s),f&&f.value&&T(f,s)}),f&&f.addEventListener("input",()=>T(f,s)),t&&t.addEventListener("blur",()=>{t.value.trim()||m(t,"Bitte Vornamen eingeben")}),i&&i.addEventListener("blur",()=>{i.value.trim()||m(i,"Bitte Nachnamen eingeben")}),a&&a.addEventListener("blur",()=>{a.value?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.value)||m(a,"Bitte g\xFCltige E-Mail eingeben"):m(a,"Bitte E-Mail eingeben")}),s&&s.addEventListener("blur",()=>L(s)),f&&f.addEventListener("blur",()=>{f.value?T(f,s):m(f,"Bitte Passwort best\xE4tigen")})}g&&g.addEventListener("click",t=>{var O,S,z,P,F,C,ke,Se,Le,xe;t.preventDefault(),l.log("Next button clicked (register step 1)"),$();let i=((O=c("#first_name",e))==null?void 0:O.value)||((S=c('input[name="first_name"]',e))==null?void 0:S.value)||"",a=((z=c("#last_name",e))==null?void 0:z.value)||((P=c('input[name="last_name"]',e))==null?void 0:P.value)||"",s=((F=c("#email-sign-in",e))==null?void 0:F.value)||((C=c('input[name="email-sign-in"]',e))==null?void 0:C.value)||"",f=((ke=c("#password-signin",e))==null?void 0:ke.value)||((Se=c('input[name="password-signin"]',e))==null?void 0:Se.value)||"",K=((Le=c("#password-signin-again",e))==null?void 0:Le.value)||((xe=c('input[name="password-signin-again"]',e))==null?void 0:xe.value)||"";if(l.log("Form values:",{firstName:i,lastName:a,email:s,hasPassword:!!f}),!i||!a){b(n,"Bitte Vor- und Nachnamen eingeben");return}if(!s||!s.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){b(n,"Bitte eine g\xFCltige E-Mail-Adresse eingeben");return}if(!f||f.length<8||!/[A-Z]/.test(f)||!/[a-z]/.test(f)||!/[0-9]/.test(f)||!/[^A-Za-z0-9]/.test(f)){b(n,"Passwort: min. 8 Zeichen, 1 Gro\xDFbuchstabe, 1 Kleinbuchstabe, 1 Zahl und 1 Sonderzeichen");return}if(f!==K){b(n,"Passw\xF6rter stimmen nicht \xFCberein");return}I={firstName:i,lastName:a,email:s,password:f},Ne()});let A=c('[data-register="btn-send"]',e),y=e.querySelector('[data-register-type="personal-info"]');function ee(){if(!y)return"";let t=c("select",y),i=(t==null?void 0:t.value)||"";if(!i&&t){let a=t.nextElementSibling;if(a&&a.classList.contains("nice-select")){let s=a.querySelector(".option.selected");s&&s.getAttribute("data-value")&&(i=s.getAttribute("data-value"))}}return i}function U(t){return t?/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(t):!1}function qe(){var a;if(!y)return!1;let t=((a=c("#dateOfBirth",y)||c('input[name="dateOfBirth"]',y)||c('input[data-toggle="datepicker"]',y))==null?void 0:a.value)||"";return!(!U(t)||!ee()||v('input[type="checkbox"][required]',y).filter(s=>{var f;return!((f=s.closest(".w-checkbox"))!=null&&f.querySelector(".text-color-gray-70"))}).some(s=>!s.checked))}function N(){if(!A)return;let t=qe();A.style.opacity=t?"":"0.5",A.style.pointerEvents=t?"auto":"none"}if(y){y.querySelectorAll(".w-checkbox").forEach(s=>{if(s.querySelector(".text-color-gray-70")){let f=s.querySelector('input[type="checkbox"]');f&&f.removeAttribute("required")}}),y.addEventListener("input",N),y.addEventListener("change",N),y.addEventListener("click",s=>{s.target.closest(".nice-select .option")&&setTimeout(N,50)}),N();let t=y.querySelector('#dateOfBirth, input[name="dateOfBirth"]'),i=y.querySelector("select"),a=[...y.querySelectorAll('input[type="checkbox"][required]')];if(t){t.addEventListener("blur",()=>{t.value?U(t.value)?h(t):m(t,"Format: TT.MM.JJJJ"):m(t,"Bitte Geburtsdatum eingeben")}),t.addEventListener("input",()=>{U(t.value)&&h(t),N()}),t.addEventListener("change",()=>{U(t.value)&&h(t),N()});let s=t.value;setInterval(()=>{t.value!==s&&(s=t.value,U(t.value)&&h(t),N())},300)}i&&i.addEventListener("change",()=>{i.value?h(i):m(i,"Bitte Geschlecht ausw\xE4hlen")}),y.addEventListener("click",s=>{s.target.closest(".nice-select .option")&&i&&setTimeout(()=>{ee()&&h(i)},100)}),a.forEach(s=>{s.addEventListener("change",()=>{s.checked?h(s):m(s,"Bitte akzeptieren")})})}A&&A.addEventListener("click",async t=>{var S,z,P,F;t.preventDefault(),l.log("Send button clicked (register step 2)"),$();let i=((S=c("#dateOfBirth",e))==null?void 0:S.value)||((z=c('input[name="dateOfBirth"]',e))==null?void 0:z.value)||((P=c('input[name="date-of-birth"]',e))==null?void 0:P.value)||((F=c('input[data-toggle="datepicker"]',e))==null?void 0:F.value)||"";if(!i){b(n,"Bitte Geburtsdatum eingeben");return}let a,s=i.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);s?a=`${s[3]}-${s[2].padStart(2,"0")}-${s[1].padStart(2,"0")}`:a=new Date(i).toISOString().split("T")[0];let f=ee();if(!f){b(n,"Bitte Geschlecht ausw\xE4hlen");return}if(v('input[type="checkbox"][required]',y||e).filter(C=>!C.checked).length>0){b(n,"Bitte stimme den Datenschutz- und Gesch\xE4ftsbedingungen zu");return}I.dateOfBirth=a,I.gender=f,l.log("Full registration data:",I),_(A,!0);try{await ie(I),k("Registrierung erfolgreich! Bitte Code eingeben.","success"),Be()}catch(C){l.error("Registration error:",C),b(n,C.message)}finally{_(A,!1)}});let B=c('[data-register="btn-signin"]',e);function me(){var a,s;let t=((a=c("#email-login",e)||c('input[name="email-login"]',e))==null?void 0:a.value)||"",i=((s=c("#password-login",e)||c('input[name="password-login"]',e))==null?void 0:s.value)||"";return!!(t&&i)}function he(){B&&(B.style.opacity=me()?"":"0.5",B.style.pointerEvents=me()?"auto":"none")}let ye=e.querySelector('[data-register-type="sign-in"]')||e.querySelector('[data-registe-type="sign-in"]');ye&&(ye.addEventListener("input",he),he()),B&&B.addEventListener("click",async t=>{var s,f,K,O;t.preventDefault(),l.log("Signin button clicked"),$();let i=((s=c("#email-login",e))==null?void 0:s.value)||((f=c('input[name="email-login"]',e))==null?void 0:f.value)||"",a=((K=c("#password-login",e))==null?void 0:K.value)||((O=c('input[name="password-login"]',e))==null?void 0:O.value)||"";if(l.log("Login attempt:",i),!i||!a){b(n,"Bitte E-Mail und Passwort eingeben");return}_(B,!0);try{await oe(i,a),k("Anmeldung erfolgreich!","success"),X(),D(),window.location.pathname.includes("/deine-bestellung")||ue()}catch(S){l.error("Login error:",S),b(n,S.message)}finally{_(B,!1)}});let H=v('input[name^="code-"]',e);H.forEach((t,i)=>{t.addEventListener("input",a=>{a.target.value.length===1&&i<H.length-1&&H[i+1].focus()}),t.addEventListener("keydown",a=>{a.key==="Backspace"&&!a.target.value&&i>0&&H[i-1].focus()})});let J=c('[data-register="btn-code-confirm"]',e);J&&J.addEventListener("click",async t=>{t.preventDefault(),l.log("Code confirm clicked"),$();let i="";if(H.forEach(a=>{i+=a.value}),l.log("Code entered:",i),i.length!==6){b(n,"Bitte den vollst\xE4ndigen 6-stelligen Code eingeben");return}_(J,!0);try{await re(i),k("E-Mail erfolgreich verifiziert!","success"),X(),D()}catch(a){l.error("Verification error:",a),b(n,a.message)}finally{_(J,!1)}});let ve=c('[data-register="code-resend"]',e);ve&&ve.addEventListener("click",async t=>{t.preventDefault(),l.log("Resend code clicked");try{await ae(),k("Code wurde erneut gesendet","success")}catch(i){l.error("Resend error:",i),k(i.message,"error")}});let we=c('[data-register="password-forget"]',e);we&&we.addEventListener("click",t=>{t.preventDefault(),l.log("Password forget clicked"),k("Passwort-Reset wird noch implementiert","info")});let Ee=c('[data-register="google-signin"]',e);Ee&&Ee.addEventListener("click",t=>{t.preventDefault(),l.log("Google signin clicked"),k("Google-Anmeldung wird noch implementiert","info")});let be=c('[data-register="apple-signin"]',e);be&&be.addEventListener("click",t=>{t.preventDefault(),l.log("Apple signin clicked"),k("Apple-Anmeldung wird noch implementiert","info")}),l.log("Auth handlers setup complete")}function D(){var u,g;let e=Z(),n=R();l.log("Updating auth UI, authenticated:",e,n),v('[data-auth-show="logged-in"]').forEach(p=>{p.style.display=e?"":"none"});let o=window.location.pathname,r=o==="/"||o==="/en"||o==="/en/"||o.includes("/vision");v('[data-auth-show="logged-out"]').forEach(p=>{p.classList.contains("nav_user")?r?p.style.display="none":p.style.display="":p.style.display=e?"none":""}),n&&(v('[data-auth-user="name"]').forEach(p=>{p.textContent=n.name}),v('[data-auth-user="email"]').forEach(p=>{p.textContent=n.email}));let d=c(".nav_user");if(d)if(e&&n){let p=(n.name||"").trim().split(/\s+/),m=((((u=p[0])==null?void 0:u[0])||"")+(((g=p[1])==null?void 0:g[0])||"")).toUpperCase();d._originalHTML||(d._originalHTML=d.innerHTML),d.innerHTML='<div style="width:35px;height:35px;border-radius:50%;background:rgba(36,91,236,0.15);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:400;color:#000;font-family:inherit;line-height:1;">'+m+"</div>"}else d._originalHTML&&(d.innerHTML=d._originalHTML)}let _e="https://calendly.com/j-erdweg-longtermhealth/biomarker-bluttest";function ue(){l.log("Opening Calendly modal");let e=R(),n=(e==null?void 0:e.name)||localStorage.getItem("userName")||"",o=(e==null?void 0:e.email)||localStorage.getItem("userEmail")||"",r=document.getElementById("calendly-modal-overlay");if(r){let p=document.getElementById("calendly-embed-container");p&&(p.innerHTML=""),r.style.display="flex",setTimeout(()=>{r.style.opacity="1"},10),ge(n,o);return}r=document.createElement("div"),r.id="calendly-modal-overlay",r.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;";let d=document.createElement("div");d.style.cssText="background:#fff;border-radius:12px;width:90vw;max-width:700px;height:85vh;max-height:750px;position:relative;overflow:hidden;";let u=document.createElement("button");u.textContent="\u2715",u.style.cssText="position:absolute;top:12px;right:16px;z-index:10;background:none;border:none;font-size:20px;cursor:pointer;color:#333;",u.addEventListener("click",j);let g=document.createElement("div");g.id="calendly-embed-container",g.style.cssText="width:100%;height:100%;",d.appendChild(u),d.appendChild(g),r.appendChild(d),document.body.appendChild(r),r.addEventListener("click",p=>{p.target===r&&j()}),setTimeout(()=>{r.style.opacity="1"},10),ge(n,o),Te()}function ge(e,n){let o=document.getElementById("calendly-embed-container");if(!o)return;let r=_e+"?hide_gdpr_banner=1";e&&(r+="&name="+encodeURIComponent(e)),n&&(r+="&email="+encodeURIComponent(n));let d=document.createElement("div");if(d.className="calendly-inline-widget",d.setAttribute("data-url",r),d.style.cssText="min-width:100%;height:100%;",o.appendChild(d),document.querySelector('script[src*="assets.calendly.com"]'))window.Calendly&&window.Calendly.initInlineWidget({url:r,parentElement:o});else{let u=document.createElement("script");u.src="https://assets.calendly.com/assets/external/widget.js",u.async=!0,document.body.appendChild(u)}l.log("Calendly widget injected with name:",e,"email:",n)}function Te(){window.addEventListener("message",e=>{var n,o,r,d,u;if(e.origin==="https://calendly.com"&&((n=e.data)==null?void 0:n.event)==="calendly.event_scheduled"){l.log("Calendly event scheduled:",e.data);let g=R(),p={userId:(g==null?void 0:g.id)||localStorage.getItem("userId"),userName:(g==null?void 0:g.name)||localStorage.getItem("userName"),userEmail:(g==null?void 0:g.email)||localStorage.getItem("userEmail"),eventUri:(r=(o=e.data.payload)==null?void 0:o.event)==null?void 0:r.uri,inviteeUri:(u=(d=e.data.payload)==null?void 0:d.invitee)==null?void 0:u.uri,scheduledAt:new Date().toISOString()};l.log("Booking data:",p),localStorage.setItem("lastBooking",JSON.stringify(p)),setTimeout(()=>{j(),k("Termin erfolgreich gebucht!","success")},1500)}})}function j(){let e=document.getElementById("calendly-modal-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300),l.log("Calendly modal closed"))}function V(){let e=document.getElementById("nav-user-dropdown");e&&e.remove()}function Oe(e){V();let n=R();if(!n)return;let o=document.createElement("div");o.id="nav-user-dropdown",o.style.cssText="position:absolute;top:100%;right:0;margin-top:8px;background:#fff;color:#000;border-radius:10px;padding:16px 20px;min-width:220px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.12);font-family:inherit;";let r=document.createElement("div");r.textContent=n.name||"",r.style.cssText="font-size:15px;font-weight:600;margin-bottom:4px;color:#000;";let d=document.createElement("div");d.textContent=n.email||"",d.style.cssText="font-size:13px;color:#4B4B4E;margin-bottom:14px;";let u=document.createElement("button");u.setAttribute("data-auth-logout",""),u.style.cssText="display:flex;align-items:center;gap:8px;width:100%;padding:8px 0;background:none;border:none;color:#000;font-size:14px;cursor:pointer;transition:opacity 0.2s;font-family:inherit;",u.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Logout',u.addEventListener("mouseenter",()=>{u.style.opacity="0.6"}),u.addEventListener("mouseleave",()=>{u.style.opacity="1"}),o.appendChild(r),o.appendChild(d),o.appendChild(u);let g=e.closest(".nav_user")||e;g.style.position="relative",g.appendChild(o)}function Ie(){let e=window.location.pathname;e==="/"||e==="/en"||e==="/en/"||e.includes("/vision")||document.addEventListener("click",o=>{let r=o.target.closest(".nav_user");if(!r){V();return}o.preventDefault(),Z()?document.getElementById("nav-user-dropdown")?V():Oe(r):Y()})}function Re(){document.addEventListener("click",e=>{e.target.closest("[data-auth-logout]")&&(e.preventDefault(),V(),se(),D(),k("Erfolgreich abgemeldet","info"),l.log("User logged out via button"))})}function fe(){l.log("Initializing global auth module"),Ce(),Re(),Ie(),D(),window.Auth={isAuthenticated:Z,getCurrentUser:R,login:oe,register:ie,verifyEmail:re,resendCode:ae,logout:se,openModal:Y,openRegister:()=>Y("register"),openLogin:()=>Y("login"),closeModal:X,openCalendly:ue,closeCalendly:j,updateUI:D},l.log("Global auth module ready. Use Auth.openModal() to open.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",fe):fe()})();})();
